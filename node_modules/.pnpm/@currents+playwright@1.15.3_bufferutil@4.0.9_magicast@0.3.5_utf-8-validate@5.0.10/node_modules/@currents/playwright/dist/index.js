"use strict";var Ii=Object.create;var te=Object.defineProperty;var Ci=Object.getOwnPropertyDescriptor;var Ti=Object.getOwnPropertyNames;var Ri=Object.getPrototypeOf,yi=Object.prototype.hasOwnProperty;var f=(e,t)=>()=>(e&&(t=e(e=0)),t);var Qe=(e,t)=>{for(var r in t)te(e,r,{get:t[r],enumerable:!0})},ln=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of Ti(t))!yi.call(e,s)&&s!==r&&te(e,s,{get:()=>t[s],enumerable:!(n=Ci(t,s))||n.enumerable});return e};var g=(e,t,r)=>(r=e!=null?Ii(Ri(e)):{},ln(t||!e||!e.__esModule?te(r,"default",{value:e,enumerable:!0}):r,e)),_i=e=>ln(te({},"__esModule",{value:!0}),e);var i=f(()=>{"use strict"});var ft,Xe=f(()=>{"use strict";i();ft=class extends Error{}});var ee,Ze=f(()=>{"use strict";i();ee={guide:{ciBuildId:"https://docs.currents.dev/guides/ci-build-id",integration:"https://docs.currents.dev/integration-with-playwright/currents-playwright"}}});function pn(e){Si.push(e)}var Si,tr=f(()=>{"use strict";i();Si=[]});var Ft,st,re=f(()=>{"use strict";i();Ft=[],st=[]});var x,ht,Dt,P,d,Et,gn,_,It,Ct,dn,mn,Mt,X,fn,Tt,ot,Bt,kt,gu,du,jt,m,mu,hn=f(()=>{"use strict";i();x=g(require("chalk")),ht=g(require("util"));E();tr();re();Dt=(...e)=>{let t=ht.default.format(...e);pn(t),console.log(t)},P=Dt,d=(...e)=>{let t=ht.default.format(...e);return st.push(t),l("WARNING: ",t),Dt(x.default.bgYellow.black(" WARNING "),t)},Et=(...e)=>{let t=ht.default.format(...e);return l("WARNING: ",t),Dt(x.default.bgYellow.black(" WARNING "),t)},gn=(...e)=>{let t=ht.default.format(...e);return l("ERRRO: ",t),Dt(x.default.bgRed.white(" ERROR "),t)},_=(...e)=>{let t=ht.default.format(...e);return Ft.push(t),l("ERROR: ",t),Dt(x.default.bgRed.white(" ERROR "),t)},It=()=>console.log(`
`+Ct()+`
`),Ct=()=>x.default.dim(Array(64).fill("=").join("")),dn=(e="",t=64)=>{let r=` start of ${e??"block"} `,n=Math.max(t-r.length,0)/2,s=Math.floor(n),o=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(o).fill("-").join("")}`)},mn=(e="",t=64)=>{let r=` end of ${e??"block"} `,n=Math.max(t-r.length,0)/2,s=Math.floor(n),o=Math.ceil(n);return x.default.dim(`${Array(s).fill("-").join("")}${r}${Array(o).fill("-").join("")}`)},Mt=(e=2)=>console.log(Array(e).fill("").join(`
`)),X=x.default.cyan,fn=x.default.blueBright,Tt=x.default.red,ot=x.default.yellow,Bt=x.default.green,kt=x.default.gray,gu=x.default.white,du=x.default.black,jt=x.default.magenta,m=x.default.dim,mu=x.default.bold});var R=f(()=>{"use strict";i();tr();hn()});function In(e){if(!e)return;if(e==="false")return!1;let t=parseInt(e,10);if(isNaN(t)||t<1)throw new En.CommanderError(255,"Invalid argument provided.","--pwc-cancel-after-failures must be a positive integer or 'false', provided: "+e);return t}var En,Cn=f(()=>{"use strict";i();En=require("commander")});function Tn(e){return F[e]?.env}function Rn(e){return F[e].cli}function yn(e){return F[e].name}function _n(){return{projectId:process.env[F.projectId.env],recordKey:process.env[F.recordKey.env],ciBuildId:process.env[F.ciBuildId.env],tag:process.env[F.tag.env]?process.env[F.tag.env]?.split(",").map(e=>e.trim()):void 0,cancelAfterFailures:In(process.env[F.cancelAfterFailures.env]),disableTitleTags:process.env[F.disableTitleTags.env],testSuiteFile:process.env[F.testSuiteFile.env],machineId:process.env[F.machineId.env],orchestrationId:process.env[F.orchestrationId.env]}}var F,er=f(()=>{"use strict";i();Cn();F={currentsConfigFile:{name:"Currents Config File Path",env:"CURRENTS_CONFIG_FILE_PATH",cli:"--pwc-config"},ciBuildId:{name:"CI Build ID",env:"CURRENTS_CI_BUILD_ID",cli:"--ci-build-id"},recordKey:{name:"Record Key",env:"CURRENTS_RECORD_KEY",cli:"--key"},projectId:{name:"Project ID",env:"CURRENTS_PROJECT_ID",cli:"--project-id"},tag:{name:"Currents Tag",env:"CURRENTS_TAG",cli:"--tag"},cancelAfterFailures:{name:"Currents Cancel After Failures",env:"CURRENTS_CANCEL_AFTER_FAILURES",cli:"--pwc-cancel-after-failures"},disableTitleTags:{name:"Disable Title Tags",env:"CURRENTS_DISABLE_TITLE_TAGS",cli:"--pwc-disable-title-tags"},testSuiteFile:{name:"Test Suite File",env:"CURRENTS_TEST_SUITE_FILE",cli:"--pwc-test-suite-file"},machineId:{name:"Machine ID",env:"CURRENTS_MACHINE_ID",cli:"--pwc-machine-id"},orchestrationId:{name:"Orchestration ID",env:"CURRENTS_ORCHESTRATION_ID",cli:"--pwc-orchestration-id"},outputFile:{name:"Output File",env:"CURRENTS_OUTPUT_FILE",cli:"--pwc-output-file"},batchSize:{name:"Batch Size",env:"CURRENTS_BATCH_SIZE",cli:"--pwc-batch-size"}}});function yt(){if(rr)return rr;if(process.env.CURRENTS_PWC_CLI_CONFIG_PATH)try{let e=JSON.parse(An.default.readFileSync(process.env.CURRENTS_PWC_CLI_CONFIG_PATH).toString());return Sn("Options from serialized CLI config file: %o",e),rr=e,e}catch(e){return Sn("Could not read CLI config file: %o",e),{}}return{}}var An,Sn,rr,nr=f(()=>{"use strict";i();An=g(require("fs"));E();Sn=l.extend("cli-options-serializer"),rr=null});function xn(e,t,r={validationFn:ir}){sr("reporter options: %o",e),sr("config file options: %o",t);let n={...D(or),...D(t),...D(e),...D(yt()),...D(_n()),orchestration:{...D(or.orchestration),...D(t?.orchestration),...D(e?.orchestration),...D(yt().orchestration)},coverage:{...D(or.coverage),...D(t?.coverage),...D(e?.coverage),...D(yt().coverage)}};r.validationFn(n),ne=n,sr("resolved currents config: %o",ne)}function ir(e){Ai.forEach(t=>{if(!e[t])throw _(`${yn(t)} is required for Currents Reporter. Use the following methods:
  - environment variable: ${m(Tn(t))}
  - CLI flag: ${m(Rn(t))}
  - reporter configuration option ${m(t)} in ${m("playwright.config.ts")}
  
  \u{1F4D6} ${ee.guide.integration}`),new ft("Missing required config variable")})}function D(e){return Object.entries(e??{}).reduce((t,[r,n])=>n===void 0?t:{...t,[r]:n},{})}function W(){return!!ne?.orchestrationId}function w(){return ne}function Pn(e){e.preserveOutput!=="always"&&d(`The "preserveOutput" property in your Playwright config is set to ${e.preserveOutput}. This may cause artifacts to be removed before they are uploaded to Currents. We recommend setting it to "always".`)}function wn(e){return e?Object.values(e).map(t=>t.name):[]}function se(e,t){return t?.projects===!0?e:Array.isArray(t?.projects)?t?.projects.length===0?e:t?.projects.filter(r=>e.includes(r)):[]}var sr,Ai,or,ne,ar=f(()=>{"use strict";i();E();Xe();Ze();R();er();nr();sr=l.extend("config"),Ai=["projectId","recordKey"],or={removeTitleTags:!1,disableTitleTags:!1,orchestration:{skipReporterInjection:!1},coverage:{projects:!1}},ne=null});function vn(e){let t=new WeakMap;function r(n){if(typeof n=="object"&&n!==null){if(t.has(n))return"[Circular]";t.set(n,!0)}}return(0,bn.cloneDeepWith)(e,r)}function oe(e){let r=Object.getOwnPropertySymbols(e).find(s=>s.toString().match(/configInternalSymbol/))??Object.getOwnPropertyNames(e).find(s=>s.match(/_internal/));return r?e[r]:(d("Could not extract internal playwright configuration"),null)}var bn,On=f(()=>{"use strict";i();bn=require("lodash");R()});var j=f(()=>{"use strict";i();ar();er();nr();On()});var Un,Nn=f(()=>{Un={name:"@currents/playwright",version:"1.15.3",main:"./dist/index.js",author:{name:"Currents Software Inc",email:"hello@currents.dev",url:"https://currents.dev"},license:"MIT",homepage:"https://currents.dev",repository:{type:"git",url:"https://github.com/currents-dev/currents-playwright-changelog.git"},scripts:{test:"vitest",rm:"rimraf dist",lint:'TIMING=1 eslint "**/*.ts*"',build:"tsup-node --minify --dts",dev:"tsup-node --watch --dts",release:"release-it --verbose","publish:npm":"npm run rm  && npm run build && ./publish.js","release-ci":"npm run rm && npm run build && ./publish.js -t latest"},bin:{pwc:"./dist/bin/pwc.js","pwc-p":"./dist/bin/pwc-p.js"},devDependencies:{"@playwright/test":"^1.44.0","@release-it/conventional-changelog":"^7.0.2","@types/async-retry":"^1.4.5","@types/babel__code-frame":"^7.0.3","@types/debug":"^4.1.12","@types/getos":"^3.0.4","@types/json-stringify-safe":"^5.0.3","@types/lodash":"^4.17.15","@types/pluralize":"^0.0.33","@types/proxy-from-env":"^1.0.4","@types/randomstring":"^1.3.0","@types/regexp.escape":"^2.0.0","@types/shelljs":"^0.8.16","@types/stack-utils":"^2.0.3","@types/tmp":"^0.2.6","@types/ws":"^8.18.1",eslint:"^9.29.0","eslint-config-custom":"*",msw:"^2.8.2","release-it":"^19.0.3",rimraf:"^6.0.1",tsconfig:"*",tsup:"^8.5.0",typescript:"^5.8.3",vitest:"^3.2.3",wtfnode:"^0.10.0"},dependencies:{"@babel/code-frame":"^7.27.1","@commander-js/extra-typings":"^12.1.0","@currents/commit-info":"1.0.1-beta.0","async-retry":"^1.3.3",axios:"^1.10.0","axios-retry":"^4.5.0",c12:"^1.11.2",chalk:"^4.1.2",commander:"^12.1.0","date-fns":"^4.1.0",debug:"^4.3.7",dotenv:"^16.5.0",execa:"^9.5.3",getos:"^3.2.1","https-proxy-agent":"^7.0.5","istanbul-lib-coverage":"^3.2.2","json-stringify-safe":"^5.0.1","lil-http-terminator":"^1.2.3",lodash:"^4.17.21",nanoid:"^3.3.8","object-sizeof":"^2.6.5","p-debounce":"^2.1.0","p-map":"^4.0.0","p-queue":"6.6.2",pino:"^9.6.0",pluralize:"^8.0.0","pretty-ms":"^7.0.1","proxy-from-env":"^1.1.0","regexp.escape":"^2.0.1","source-map-support":"^0.5.21","stack-utils":"^2.0.6",tmp:"^0.2.3","tmp-promise":"^3.0.3","ts-pattern":"^5.7.1",ws:"^8.18.3"},files:["dist","!**/*.map","!**/*/*.map","**/*.LEGAL.txt","LICENSE.md","README.md","CHANGELOG.md"],keywords:["playwright","playwright dashboard","cloud dashboard","reporter","currents","tests reporter","sorry cypress","ci"],exports:{".":{import:"./dist/index.js",require:"./dist/index.js"},"./discovery":{import:"./dist/reporters/discovery.js",require:"./dist/reporters/discovery.js"},"./orchestration":{import:"./dist/orchestration/index.js",require:"./dist/orchestration/index.js"},"./package.json":"./package.json"},publishConfig:{access:"public",registry:"https://registry.npmjs.org"},"release-it":{npm:{publish:!1},github:{release:!0},plugins:{"@release-it/conventional-changelog":{preset:"angular",header:"# Changelog",ignoreVersion:!0,infile:"../../CHANGELOG.md"}},git:{commitMessage:"chore: release v${version}",tagName:"v${version}"},hooks:{"before:github:release":"npm run --prefix ../../ update-public-changelog"}}}});var ie,ur=f(()=>{"use strict";i();Nn();ie=Un.version});function ue(e={}){let t=Ln.default.create(e);return t.interceptors.request.use(r=>{let n={...r},s=t.getUri(r),o=Dn.default.getProxyForUrl(s);return o&&(Pi("Using HTTP proxy %s for %s ",o,s),n.proxy=!1,n.httpsAgent=wi(o)),n}),t}function wi(e){return ae||(ae=new Fn.HttpsProxyAgent(e),ae)}var Ln,Fn,Dn,Pi,ae,cr=f(()=>{"use strict";i();Ln=g(require("axios")),Fn=require("https-proxy-agent"),Dn=g(require("proxy-from-env"));E();Pi=l.extend("axios");ae=null});var lr,Mn,Bn=f(()=>{"use strict";i();lr=()=>process.env.CURRENTS_API_URL??"https://cy.currents.dev",Mn=()=>3e4});function jn(){ce.addListener("runCancelled",Gn)}function $n(){ce.removeListener("runCancelled",Gn)}function Gn(){l("Run cancelled: %s",gr()),process.exit(1)}var kn,ce,pr=f(()=>{"use strict";i();kn=g(require("events"));E();le();ce=new kn.default});var dr,pe,gr,ge,Hn=f(()=>{"use strict";i();R();pr();dr={cancellationReason:null},pe=e=>{dr.cancellationReason||(dr.cancellationReason=e)},gr=()=>dr.cancellationReason,ge=({showWarning:e=!0}={})=>{let t=gr();t&&(e&&d("%s",t),ce.emit("runCancelled",t))}});var le=f(()=>{"use strict";i();Hn()});var Wn,it,de=f(()=>{"use strict";i();Wn=require("nanoid"),it=(0,Wn.customAlphabet)("abcdefghijklmnopqrstuvwxyz",10)});var me,mr,_t,fe,he=f(()=>{"use strict";i();me=require("ts-pattern"),mr={outcome:null,scannerConfig:null,currentsConfig:null,internalConfig:null},_t=(e,t)=>(0,me.match)(e).with(me.P.union("scannerConfig","currentsConfig","internalConfig"),r=>{mr[r]=t}).with("outcome",r=>{mr[r]=t}).exhaustive(),fe=()=>mr});function Yn(e){(0,O.match)(e).when(qn.isAxiosError,bi).otherwise(()=>{d("Unexpected error while sending network request: %s",e)})}function bi(e){return(0,O.match)(e).with({code:"ECONNABORTED"},()=>{d("Network connection aborted")}).with({code:"ECONNREFUSED"},()=>{d("Network connection aborted")}).with({code:"ECONNRESET"},()=>{d("Network connection reset")}).with({code:"ETIMEDOUT"},()=>{d("Network connection timeout")}).with({response:O.P.not(O.P.nullish)},t=>{vi(t,{status:t.response.status,data:t.response.data})}).otherwise(t=>{d(`[currents] Unexpected network error: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,payload:e.response?.config.data,requestId:$t(e)})})}function vi(e,{status:t,data:r}){(0,O.match)(t).with(401,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url}} - 401 Unauthorized Request from cloud service`)}).with(400,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 400 Bad Request from cloud service:
%o`,r)}).with(429,()=>{d(`[currents] ${e.response?.config.method} ${e.response?.config.url} - 429 Too Many Requests from cloud service`)}).with(422,()=>{Oi(e,r)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:$t(e)})})}function Oi(e,t){(0,O.match)(t).with({code:fr.MISSING_SUITE,message:O.P.string,errors:O.P.array(O.P.string)},async r=>{let{message:n,errors:s}=r;Mt(1),_(...Vn(n,s)),Ee({id:it(),text:(0,Kn.default)(fe(),null,2)}).then(o=>{_(`Please share this URL with Currents support for further investigation:
${o}`)}).catch(o=>{d("Failed to upload debug artifact: %s",o)}),Mt(1)}).with({code:fr.RUN_CANCELLED,message:O.P.string},r=>{pe(r.message),ge()}).with({code:fr.RUN_EXPIRED,message:O.P.string},r=>{d(r.message)}).with({message:O.P.string,errors:O.P.array(O.P.string)},r=>{let{message:n,errors:s}=r;Mt(1),d(...Vn(n,s)),Mt(1)}).otherwise(()=>{d(`[currents] Unexpected network response: %s
%O`,e.message,{method:e.response?.config.method,url:e.response?.config.url,status:e.response?.status,requestId:$t(e)})})}function Vn(e,t){return Jn.default.isString(e)?t?.length===0?[e]:[e,`
${(t??[]).map(r=>`  - ${r}`).join(`
`)}
`]:["Unexpected network error"]}function $t(e){return e?.response?.headers["apigw-requestid"]}var qn,Kn,Jn,O,fr,hr=f(()=>{"use strict";i();qn=require("axios"),Kn=g(require("json-stringify-safe")),Jn=g(require("lodash")),O=require("ts-pattern");le();de();R();Er();he();fr={RUN_CANCELLED:"RUN_CANCELLED",RUN_EXPIRED:"RUN_EXPIRED",MISSING_SUITE:"MISSING_SUITE"}});function Zn(e,t,r){let n=r.method?.toUpperCase(),s=r.url,o=$t(t),a=(0,zn.default)(Cr(e)),u=`Network request '${n} ${s}' failed: '${t.message}'.${o?` Request ID: ${o}.`:""} Next attempt is in ${a} (${e}/${r["axios-retry"]?.retries||Tr()}).`;Qn(u),d(u)}var Ir,zn,Qn,Cr,Xn,Tr,ts=f(()=>{"use strict";i();Ir=require("axios"),zn=g(require("pretty-ms"));E();R();hr();Qn=l.extend("http"),Cr=e=>[3*1e3,15*1e3,30*1e3][e-1],Xn=e=>(Qn("isRetriableError: %o",{message:e.message,code:"code"in e?e.code:void 0,status:"response"in e?e.response?.status:void 0,headers:"response"in e?e.response?.headers:void 0,data:"response"in e?e.response?.data:void 0,isAxiosError:(0,Ir.isAxiosError)(e)}),"code"in e&&e.code&&["ECONNABORTED","ECONNREFUSED","ECONNRESET","ETIMEDOUT","ENETRESET","ENOTFOUND","EAI_AGAIN"].includes(e.code)?!0:(0,Ir.isAxiosError)(e)?[429,500,502,503,504].includes(e.response?.status??0):!1),Tr=()=>3});function ps(e){ls["x-pw-version"]=e??"0.0.0"}function Fi(){let e=ue({baseURL:lr(),timeout:Mn(),transitional:{clarifyTimeoutError:!0}});return e.interceptors.request.use(async t=>{let{currentsOptions:r}=t,n={...Li,...r};return n.enableCompression&&(0,as.default)(t.data)>n.compressThresholdBytes?(t.headers["Content-Encoding"]="gzip",{...t,data:await Ui((0,ss.default)(t.data))}):t}),e.interceptors.request.use(t=>{let r=t["axios-retry"]?.retryCount??0,n=w();t.headers.set({...ls,"Accept-Encoding":"gzip, deflate, br","x-currents-idempotency-key":t.headers["x-currents-idempotency-key"]??(0,is.nanoid)(),"x-pwc-request-attempt":r,"x-currents-key":n?.recordKey??null}),n?.orchestrationId&&t.headers.set("x-currents-orchestration-id",n.orchestrationId),n?.machineId&&t.headers.set("x-currents-machine-id",n.machineId),t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json");let s={...os.default.pick(t,"method","url","headers"),data:Buffer.isBuffer(t.data)?"buffer":t.data};return r?es("network request retry: %o",rs({...s,isRetry:!0})):es("network request: %o",rs(s)),t}),(0,ns.default)(e,{retries:Tr(),retryCondition:Xn,retryDelay:Cr,shouldResetTimeout:!0,onRetry:Zn}),e}function gs(){return Ie||(Ie=Fi(),Ie)}function rs(e){return{method:e.method,baseUrl:lr(),url:e.url,data:e.isRetry?"<retry>":Di(e.data),headers:{...e.headers,"x-currents-key":"***"}}}function Di(e){return e?.results?.raw?{...e,results:{...e.results,raw:"***"}}:e}var ns,ss,os,is,as,us,cs,es,Ni,ls,Ui,Ie,Li,Rr=f(()=>{"use strict";i();ns=g(require("axios-retry")),ss=g(require("json-stringify-safe")),os=g(require("lodash")),is=require("nanoid"),as=g(require("object-sizeof")),us=require("util"),cs=g(require("zlib"));j();E();ur();cr();Bn();ts();es=l.extend("http"),Ni=1024*1024*1,ls={"x-pw-version":"0.0.0","x-pwc-version":ie},Ui=(0,us.promisify)(cs.default.gzip);Ie=null,Li={enableCompression:!1,compressThresholdBytes:Ni}});async function L(e,t=gs){try{let r=await t().request(e);return ds("network response: %o",{...ms.default.omit(r,"request","config"),url:r.config.url,method:r.config.method}),r}catch(r){let n=r;throw ds("network error: %o",{code:n.code,message:n.message,url:n.config?.url,method:n.config?.method,status:n.response?.status,headers:n.response?.headers,data:n.response?.data}),Yn(n),n}}var ms,ds,fs=f(()=>{"use strict";i();ms=g(require("lodash"));E();Rr();hr();ds=l.extend("http")});var at=f(()=>{"use strict";i();fs()});var hs={};Qe(hs,{getDebugUrl:()=>Mi});var Mi,Es=f(()=>{"use strict";i();at();Mi=({runId:e,type:t})=>L({method:"POST",url:"runs/debug-logs",data:{type:t,runId:e}}).then(r=>r.data)});function Bi(e,t){return Ce({path:e,name:null,uploadUrl:t,contentType:"text/plain"},"text/plain",void 0)}async function Ce(e,t,r){let n=await Cs.default.readFile(e.path);return yr("Uploading file %s",e.uploadUrl,{buffer:Buffer.byteLength(n)}),Rs(n,e.uploadUrl,t,r)}async function _r(e,t,r){return yr("Uploading buffer %s",e.name,{buffer:Buffer.byteLength(e.buffer)}),Rs(e.buffer,e.uploadUrl,t,r)}async function ki(e,t,r,n){return ue().request({method:"put",url:t,data:e,onUploadProgress:n,headers:{"Content-Disposition":"inline","Content-Type":r}})}async function Rs(...e){await(0,Is.default)(async()=>{await ki(...e)},{retries:5,onRetry:(t,r)=>{if(yr(`Upload failed %d out of 5 attempts: %s 
 %o`,r,t.message,t.response?.data),r===5){_(`Cannot upload after ${r} times: ${t.message}`);return}d(`Upload failed ${r} out of 5 attempts: ${t.message}`)}})}var Is,Cs,yr,Ts,ys=f(()=>{"use strict";i();Is=g(require("async-retry")),Cs=g(require("fs/promises"));E();cr();R();yr=l.extend("upload"),Ts=(s=>(s.PNG="image/png",s.WEBM="video/webm",s.TEXT="text/plain",s.ZIP="application/zip",s))(Ts||{})});var _s={};Qe(_s,{ContentType:()=>Ts,sendBuffer:()=>_r,sendPath:()=>Ce,uploadText:()=>Bi});var Sr=f(()=>{"use strict";i();ys()});async function Ee(e){let{getDebugUrl:t}=await Promise.resolve().then(()=>(Es(),hs));try{let{readUrl:r,uploadUrl:n}=await t({runId:e.id,type:"pw-debug"}),{uploadText:s,sendBuffer:o}=await Promise.resolve().then(()=>(Sr(),_s));return"text"in e&&await o({name:`${e.id}-discovery-debug.log`,buffer:Buffer.from(e.text,"utf-8"),contentType:"text/plain",uploadUrl:n},"text/plain",void 0),"path"in e&&await s(e.path,n),r}catch{return null}}var Ar,xr=f(()=>{"use strict";i();Ar=g(require("debug"))});function ji(e){return e==="false"?!1:e==="remote"?"remote":e==="full"?"full":!!e}var Ss,As,xs=f(()=>{"use strict";i();Ss=require("@commander-js/extra-typings"),As=new Ss.Option("--pwc-debug [boolean | 'remote' | 'full']","enable debug logs for the reporter. Specify 'remote' to upload logs to Currents. Specify 'full' to dump the debug logs to stdout and upload to Currents.").argParser(ji).env("CURRENTS_DEBUG")});var Ps,ws,bs=f(()=>{"use strict";i();Ps=require("@commander-js/extra-typings");xs();ws=()=>new Ps.Command().allowUnknownOption().addOption(As).helpOption(!1)});var Z,vs,wr,Os,Ns,Pr,Te,br=f(()=>{"use strict";i();Z=g(require("debug")),vs=g(require("fs")),wr=g(require("path")),Os=g(require("util")),Ns=require("fs/promises");de();R();bs();xr();Z.default.useColors=function(){return!1};Pr=Z.default.log,Te=class e{constructor(t="core"){this.source=t;this.pipelines={};if(this.mode=ws().parse().opts().pwcDebug??!1,this.debug=(0,Z.default)(`currents:remote-debug:${this.source}`),!this.mode)return this;if(!this.shouldEnableDebug())return this;let r=process.env.DEBUG?`${process.env.DEBUG},currents*`:"currents*";if(Z.default.enable(r),!this.shouldUploadRemoteDebug())return this;let n=it(),s=wr.default.resolve(".currents-debug"),o=wr.default.resolve(s,`${n}.log`);(0,Ns.mkdir)(s,{recursive:!0}),P(m(`\u{1F47E} Initiated remote ${this.source} debug log collection:`),m(o));let a=vs.default.createWriteStream(o,{flags:"a"});return Z.default.log=(...u)=>{this.mode&&(a.write(`${Os.default.formatWithOptions({colors:!1},...u)}
`),this.shouldMuteLocalStdout()||Pr(...u))},this.pipelines[n]={id:n,writeStream:a,type:this.source,tempFilePath:o},this}static factory(t="core"){return this.instance||(this.instance=new e(t)),this.instance}getDebugMode(){return this.mode}async finalize({runId:t}={runId:void 0}){try{let r=Object.keys(this.pipelines);r.length===0&&(this.debug("No debug pipelines found"),Z.default.log=Pr);for(let n of r)await this.uploadDebug(n,t??it())}catch{}finally{Z.default.log=Pr}}async uploadDebug(t,r){let n=this.pipelines[t];if(!n){this.debug("No debug pipeline found for id %s",t);return}P(m(`\u{1F47E} ${n.type} debug log written:`),m(n?.tempFilePath));try{let s=await Ee({id:r,path:n.tempFilePath});n?.writeStream.end(),P(m(`\u{1F47E} ${n.type} debug log uploaded:`),m(s))}catch(s){d(`Failed to upload ${n.type}} debug log ${m(n.tempFilePath)}: ${s.message}`)}}shouldEnableDebug(){return this.mode==="full"||this.mode==="remote"||this.mode===!0}shouldUploadRemoteDebug(){return this.mode==="full"||this.mode==="remote"}shouldMuteLocalStdout(){return this.mode==="remote"}}});var Er=f(()=>{"use strict";i();xr();br()});var l,E=f(()=>{"use strict";i();Er();l=(0,Ar.default)("currents")});var Xa={};Qe(Xa,{configHelpers:()=>za,currentsReporter:()=>Ja,default:()=>Qa,fixtures:()=>Ya});module.exports=_i(Xa);i();i();i();var Vs=g(require("crypto")),ve=g(require("fs")),rt=g(require("path"));E();i();var Re=g(require("fs")),Us=g(require("istanbul-lib-coverage")),Ls=g(require("p-map"));E();var ye=l.extend("coverage");function J({target:e,stage:t}){return({event:r,status:n,message:s,details:o})=>{let a=o?JSON.stringify(o):"",u=`[${t}] [${r}] [${n}] ${s} ${a}`,p=["test_attempt_reports_generation","test_attempt_reports_merging"].includes(t)?u:`${u} [${JSON.stringify(e)}]`;ye(p)}}async function _e(e){try{return await Re.default.promises.readdir(e)}catch(t){return ye(t),null}}async function $i(e){try{return await Re.default.promises.readFile(e,"utf-8")}catch(t){return ye(t),null}}async function Gi(e){try{let t=JSON.parse(e);return Object.keys(t).length===0?"empty":t}catch(t){return ye(t),"invalid"}}async function Hi(e,t){try{let n=(await Re.default.promises.stat(e)).size/(1024*1024),s=await $i(e);if(!s)return t({event:"file_read",status:"failed",message:"Failed to read file",details:{filePath:e,fileSizeInMB:n}}),null;t({event:"file_read",status:"passed",message:"File read successfully",details:{filePath:e,fileSizeInMB:n}});let o=await Gi(s);switch(o){case"empty":return t({event:"parse",status:"passed",message:"Coverage JSON is empty",details:{filePath:e}}),null;case"invalid":return t({event:"parse",status:"failed",message:"Coverage report is not a valid JSON",details:{filePath:e}}),null;default:return t({event:"parse",status:"passed",message:"Coverage report parsed successfully",details:{filePath:e}}),o}}catch(r){return t({event:"file_read",status:"failed",message:"Error processing coverage file",details:{filePath:e,error:r}}),null}}async function Se(e,t){let r=Us.default.createCoverageMap({}),n=0;if(await(0,Ls.default)(e,async s=>{let o=await Hi(s,t);if(o)try{r.merge(o),n++,t({event:"merge",status:"passed",message:"Merged file successfully",details:{filePath:s}})}catch(a){t({event:"merge",status:"failed",message:"Failed to merge file",details:{filePath:s,error:a}})}},{concurrency:5}),n===0)return t({event:"merge",status:"failed",message:"No files merged",details:{files:e.length}}),null;t({event:"merge",status:"passed",message:"Merged files successfully",details:{files:n}});try{let s=r.toJSON();return t({event:"parse",status:"passed",message:"Parsed coverage map data",details:{files:e.length}}),s}catch(s){t({event:"parse",status:"failed",message:"Failed to parse coverage map data",details:{files:e.length,error:s}})}return null}var Fs=(e,t={})=>t.coverage?.projects===!0?!0:Array.isArray(t.coverage?.projects)&&t.coverage.projects.includes(e);i();i();var vr=require("lodash");i();var Ae=g(require("path"));function Ds(e,t){return Wi(Ae.default.relative(t,e.file))}function Wi(e){return e.split(Ae.default.sep).join(Ae.default.posix.sep)}function tt(e){return et(e.parent.project())}function A(e){let t=e.titlePath(),r=Pe(e).title;return t.slice(t.indexOf(r)+1,t.length)}function xe(e){return e.titlePath().filter(t=>!!t).join(" > ")}function Pe(e){let t=e.parent;for(;t.parent?.location;)t=t.parent;return t}function $(e,t){let r=Pe(e).location;return Ds(r,t.rootDir)}function M(e){return e.id??e._id}function ut(e,t){return`${M(e)}-${t.retry}`}function Ms(e){return{workerIndex:(0,vr.isNil)(e.results[0]?.workerIndex)?-1:e.results[0].workerIndex,parallelIndex:(0,vr.isNil)(e.results[0]?.parallelIndex)?-1:e.results[0].parallelIndex}}function et(e){if(!e)return"__currents_no_project__";let r=("__projectId"in e?e.__projectId:"").trim(),n=e.name.trim()?r:`project${r?`-0${r}`:""}`;if(n.length>256)throw new Error(`Project name is too long for ${n}`);return n}function Gt(e){let t=(A(e).join(" ").match(/@(\S+)/g)??[]).filter(Boolean).map(r=>r);return Array.from(new Set([...t,...e.tags??[]].map(r=>r.trim()).map(r=>r.replace("@",""))))}R();i();var we=g(require("fs")),js=g(require("os")),be=g(require("path"));i();var Ht={OR8N_SUITE_FILE_PREFIX:"currents-or8n-",FIXTURES_DIR_PREFIX:"currents-fixtures-",FIXTURES_CONFIG_ERR_FILE:"config_fixture_error.log",FIXTURES_WARNING_FILE_PREFIX:"config_fixture_warning"},Wt={prefix:"_currents:test:actions:v1",BEFORE:"_currents:test:actions:v1:before",AFTER:"_currents:test:actions:v1:after"},Y={ACTION_SKIP:"_currents:rule:skip",ACTION_QUARANTINE:"_currents:rule:quarantine",ACTION_TAG:"_currents:rule:tag",ACTION_MATCH:"_currents:action:match",ACTION_SKIP_POST:"_currents:rule:skip-post",ACTION_QUARANTINE_POST:"_currents:rule:quarantine-post"};i();var Vt=g(require("fs")),Vi=require("tmp-promise");function Bs(e){try{return Vt.closeSync(Vt.openSync(e,"wx")),!0}catch(t){if(t.code==="EEXIST")return!1;throw t}}R();var ks=()=>process.env.CURRENTS_FIXTURES_TMP_DIR??be.resolve(js.tmpdir(),`${Ht.FIXTURES_DIR_PREFIX}${process.ppid}`),$s=(e,t)=>{let r=t.stack??t.message;we.appendFileSync(e,r)},Or=e=>(we.mkdirSync(ks(),{recursive:!0}),be.join(ks(),e)),St=(e,t)=>{let r=Or(`${Ht.FIXTURES_WARNING_FILE_PREFIX}_${e}.log`);Bs(r)&&t.forEach(s=>d(s))};var qs=l.extend("fixture");function qi(e){return e.coverage?.dir?rt.default.resolve(e.coverage?.dir):rt.default.join(process.cwd(),".nyc_output")}function Nr(e){return e.name||"project"}function Ki(e,t){return rt.default.join(e,Nr(t))}function Ji(){return Vs.default.randomBytes(16).toString("hex")}async function Yi(e,t){let r=await _e(e);if(!r)return t({event:"find",status:"failed",message:"Coverage directory not found",details:{coverageFiles:r}}),null;if(r.length===0)return t({event:"find",status:"failed",message:"No coverage files found",details:{coverageFiles:r,coverageDir:e}}),null;let n=r.map(s=>rt.default.join(e,s));return Se(n,t)}async function zi(e,t,r){let{project:n,testId:s,retry:o,titlePath:a}=t,u=Nr(n),p=rt.default.join(r,`${s}-${o}`),h=J({target:{projectId:u,titlePath:a,testId:s,attemptId:o},stage:"test_attempt_reports_generation"});return await e.addInitScript(()=>window.addEventListener("beforeunload",()=>{if(console.info("Location: "+window.location.href),!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ before unloading the page.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})),await ve.default.promises.mkdir(p,{recursive:!0}),h({event:"file_write",status:"passed",message:"Coverage directory created",details:{coverageDir:p}}),await e.exposeFunction("collectIstanbulCoverage",C=>{if(!C)return;let I=rt.default.join(p,`${Ji()}.json`);try{ve.default.writeFileSync(I,C),h({event:"file_write",status:"passed",message:"Coverage file created",details:{coverageFilePath:I}})}catch(T){h({event:"file_write",status:"failed",message:"Failed to create coverage file",details:{coverageFilePath:I,error:T}})}}),p}async function Qi(e,t,r,n){let{project:s,testId:o,retry:a,titlePath:u}=t,p=Nr(s);for(let T of e.pages())try{await T.evaluate(()=>{if(!window.__coverage__){console.warn("Coverage data is not available in window.__coverage__ after test execution. This may result in incomplete coverage reports.");return}window.collectIstanbulCoverage(JSON.stringify(window.__coverage__))})}catch{d("Failed to collect coverage from all pages. Coverage may be incomplete")}let h=J({target:{projectId:p,titlePath:u,testId:o,attemptId:a},stage:"test_attempt_reports_merging"}),C=await Yi(n,h);if(!C){h({event:"merge",status:"failed",message:"Failed to obtain coverage map",details:{coverageDir:n}});return}let I=rt.default.join(r,`${o}-${a}.json`);try{await ve.default.promises.writeFile(I,JSON.stringify(C,null,2)),h({event:"file_write",status:"passed",message:"Test attempt coverage file created",details:{coverageOutputPath:I}})}catch(T){h({event:"file_write",status:"failed",message:"Failed to create test attempt coverage file",details:{coverageOutputPath:I,error:T}})}}var Xi=async function({context:e,currentsConfig:t,use:r,testInfo:n}){if(!t)return await St("coverageFixture",["Currents config not found. Skipping coverage fixture"]),await r(e);if(!Fs(et(n.project),t))return qs("Coverage is disabled"),await r(e);let{project:s}=n,o,a;try{o=Ki(qi(t),s),a=await zi(e,n,o)}catch(u){d("Failed to setup coverage context",u)}if(await r(e),!(!o||!a))try{await Qi(e,n,o,a)}catch(u){d("Failed to collect coverage",u)}},Ks=async({context:e,currentsFixturesEnabled:t,currentsConfig:r},n,s)=>{if(!t)return qs("Currents fixtures disabled, skipping coverage fixture"),await n(e);await Xi({context:e,currentsConfig:r,use:n,testInfo:s})};i();i();i();var Ur=class{constructor(){this._state={}}getState(t){return this._state[t]}upsertState(t,r){return this._state[t]||(typeof r=="function"?this._state[t]=r():this._state[t]=r),this._state[t]}async populateState(t,r){return this._state[t]||(this._state[t]=await r),this._state[t]}},V=new Ur;E();i();var to=require("@currents/commit-info"),eo=require("lodash");i();var Ne=require("lodash");E();i();var S=require("lodash");E();de();var Oe=l.extend("ci"),Zi=(e,...t)=>(0,S.chain)(t).compact().join(e).value(),ta=(e,t)=>(0,S.set)(e,(0,S.camelCase)(t),process.env[t]),y=e=>(0,S.transform)(e,ta,{}),ea=()=>process.env.TF_BUILD&&process.env.TF_BUILD_BUILDNUMBER,ra=()=>process.env.TF_BUILD&&process.env.AZURE_HTTP_USER_AGENT,na=()=>(0,S.some)(process.env,(e,t)=>/^CODEBUILD_/.test(t)),sa=()=>process.env.bamboo_buildNumber,oa=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&process.env.CODESHIP,ia=()=>process.env.CI_NAME&&process.env.CI_NAME==="codeship"&&!process.env.CODESHIP,aa=()=>(0,S.some)(process.env,(e,t)=>/^CONCOURSE_/.test(t)),ua=()=>process.env.GITLAB_CI||process.env.CI_SERVER_NAME&&/^GitLab/.test(process.env.CI_SERVER_NAME),ca=()=>process.env.GCP_PROJECT||process.env.GCLOUD_PROJECT||process.env.GOOGLE_CLOUD_PROJECT,la=()=>process.env.JENKINS_URL||process.env.JENKINS_HOME||process.env.JENKINS_VERSION||process.env.HUDSON_URL||process.env.HUDSON_HOME,pa=()=>process.env.WERCKER||process.env.WERCKER_MAIN_PIPELINE_STARTED,ga={appveyor:"APPVEYOR",azure:ra,awsCodeBuild:na,bamboo:sa,bitbucket:"BITBUCKET_BUILD_NUMBER",buildkite:"BUILDKITE",circle:"CIRCLECI",codeshipBasic:oa,codeshipPro:ia,concourse:aa,codeFresh:"CF_BUILD_ID",drone:"DRONE",githubActions:"GITHUB_ACTIONS",gitlab:ua,goCD:"GO_JOB_NAME",googleCloud:ca,jenkins:la,semaphore:"SEMAPHORE",shippable:"SHIPPABLE",teamcity:"TEAMCITY_VERSION",teamfoundation:ea,travis:"TRAVIS",wercker:pa,netlify:"NETLIFY",layerci:"LAYERCI"};function da(){let{env:e}=process;return(0,S.findKey)(ga,t=>{if((0,S.isString)(t))return e[t];if((0,S.isFunction)(t))return t()})}var Js=()=>({appveyor:y(["APPVEYOR_JOB_ID","APPVEYOR_ACCOUNT_NAME","APPVEYOR_PROJECT_SLUG","APPVEYOR_BUILD_NUMBER","APPVEYOR_BUILD_VERSION","APPVEYOR_PULL_REQUEST_NUMBER","APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH"]),azure:y(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID","BUILD_REPOSITORY_URI","SYSTEM_TEAMPROJECT","SYSTEM_COLLECTIONURI"]),awsCodeBuild:y(["CODEBUILD_BUILD_ID","CODEBUILD_BUILD_NUMBER","CODEBUILD_RESOLVED_SOURCE_VERSION","CODEBUILD_SOURCE_REPO_URL","CODEBUILD_SOURCE_VERSION"]),bamboo:y(["bamboo_buildNumber","bamboo_buildResultsUrl","bamboo_planRepository_repositoryUrl","bamboo_buildKey"]),bitbucket:y(["BITBUCKET_REPO_SLUG","BITBUCKET_REPO_OWNER","BITBUCKET_BUILD_NUMBER","BITBUCKET_PARALLEL_STEP","BITBUCKET_STEP_RUN_NUMBER","BITBUCKET_PR_ID","BITBUCKET_PR_DESTINATION_BRANCH","BITBUCKET_PR_DESTINATION_COMMIT"]),buildkite:y(["BUILDKITE_REPO","BUILDKITE_SOURCE","BUILDKITE_JOB_ID","BUILDKITE_BUILD_ID","BUILDKITE_BUILD_URL","BUILDKITE_BUILD_NUMBER","BUILDKITE_PULL_REQUEST","BUILDKITE_PULL_REQUEST_REPO","BUILDKITE_PULL_REQUEST_BASE_BRANCH"]),circle:y(["CIRCLE_JOB","CIRCLE_BUILD_NUM","CIRCLE_BUILD_URL","CIRCLE_PR_NUMBER","CIRCLE_PR_REPONAME","CIRCLE_PR_USERNAME","CIRCLE_COMPARE_URL","CIRCLE_WORKFLOW_ID","CIRCLE_PULL_REQUEST","CIRCLE_REPOSITORY_URL","CI_PULL_REQUEST"]),codeshipBasic:y(["CI_BUILD_ID","CI_REPO_NAME","CI_BUILD_URL","CI_PROJECT_ID","CI_BUILD_NUMBER","CI_PULL_REQUEST"]),codeshipPro:y(["CI_BUILD_ID","CI_REPO_NAME","CI_PROJECT_ID"]),concourse:y(["BUILD_ID","BUILD_NAME","BUILD_JOB_NAME","BUILD_PIPELINE_NAME","BUILD_TEAM_NAME","ATC_EXTERNAL_URL"]),codeFresh:y(["CF_BUILD_ID","CF_BUILD_URL","CF_CURRENT_ATTEMPT","CF_STEP_NAME","CF_PIPELINE_NAME","CF_PIPELINE_TRIGGER_ID","CF_PULL_REQUEST_ID","CF_PULL_REQUEST_IS_FORK","CF_PULL_REQUEST_NUMBER","CF_PULL_REQUEST_TARGET"]),drone:y(["DRONE_JOB_NUMBER","DRONE_BUILD_LINK","DRONE_BUILD_NUMBER","DRONE_PULL_REQUEST"]),githubActions:y(["GITHUB_WORKFLOW","GITHUB_ACTION","GITHUB_EVENT_NAME","GITHUB_RUN_ID","GITHUB_RUN_ATTEMPT","GITHUB_REPOSITORY"]),gitlab:y(["CI_PIPELINE_ID","CI_PIPELINE_URL","CI_BUILD_ID","CI_JOB_ID","CI_JOB_URL","CI_JOB_NAME","GITLAB_HOST","CI_PROJECT_ID","CI_PROJECT_URL","CI_REPOSITORY_URL","CI_ENVIRONMENT_URL","CI_DEFAULT_BRANCH"]),goCD:y(["GO_SERVER_URL","GO_ENVIRONMENT_NAME","GO_PIPELINE_NAME","GO_PIPELINE_COUNTER","GO_PIPELINE_LABEL","GO_STAGE_NAME","GO_STAGE_COUNTER","GO_JOB_NAME","GO_TRIGGER_USER","GO_REVISION","GO_TO_REVISION","GO_FROM_REVISION","GO_MATERIAL_HAS_CHANGED"]),googleCloud:y(["BUILD_ID","PROJECT_ID","REPO_NAME","BRANCH_NAME","TAG_NAME","COMMIT_SHA","SHORT_SHA"]),jenkins:y(["BUILD_ID","BUILD_URL","BUILD_NUMBER","ghprbPullId"]),semaphore:y(["SEMAPHORE_BRANCH_ID","SEMAPHORE_BUILD_NUMBER","SEMAPHORE_CURRENT_JOB","SEMAPHORE_CURRENT_THREAD","SEMAPHORE_EXECUTABLE_UUID","SEMAPHORE_GIT_BRANCH","SEMAPHORE_GIT_DIR","SEMAPHORE_GIT_REF","SEMAPHORE_GIT_REF_TYPE","SEMAPHORE_GIT_REPO_SLUG","SEMAPHORE_GIT_SHA","SEMAPHORE_GIT_URL","SEMAPHORE_JOB_COUNT","SEMAPHORE_JOB_ID","SEMAPHORE_JOB_NAME","SEMAPHORE_JOB_UUID","SEMAPHORE_PIPELINE_ID","SEMAPHORE_PLATFORM","SEMAPHORE_PROJECT_DIR","SEMAPHORE_PROJECT_HASH_ID","SEMAPHORE_PROJECT_ID","SEMAPHORE_PROJECT_NAME","SEMAPHORE_PROJECT_UUID","SEMAPHORE_REPO_SLUG","SEMAPHORE_TRIGGER_SOURCE","SEMAPHORE_WORKFLOW_ID","PULL_REQUEST_NUMBER"]),shippable:y(["SHIPPABLE_BUILD_ID","SHIPPABLE_BUILD_NUMBER","SHIPPABLE_COMMIT_RANGE","SHIPPABLE_CONTAINER_NAME","SHIPPABLE_JOB_ID","SHIPPABLE_JOB_NUMBER","SHIPPABLE_REPO_SLUG","IS_FORK","IS_GIT_TAG","IS_PRERELEASE","IS_RELEASE","REPOSITORY_URL","REPO_FULL_NAME","REPO_NAME","BUILD_URL","BASE_BRANCH","HEAD_BRANCH","IS_PULL_REQUEST","PULL_REQUEST","PULL_REQUEST_BASE_BRANCH","PULL_REQUEST_REPO_FULL_NAME"]),teamcity:null,teamfoundation:y(["BUILD_BUILDID","BUILD_BUILDNUMBER","BUILD_CONTAINERID"]),travis:y(["TRAVIS_JOB_ID","TRAVIS_BUILD_ID","TRAVIS_BUILD_WEB_URL","TRAVIS_REPO_SLUG","TRAVIS_JOB_NUMBER","TRAVIS_EVENT_TYPE","TRAVIS_COMMIT_RANGE","TRAVIS_BUILD_NUMBER","TRAVIS_PULL_REQUEST","TRAVIS_PULL_REQUEST_BRANCH","TRAVIS_PULL_REQUEST_SHA"]),wercker:null,netlify:y(["BUILD_ID","CONTEXT","URL","DEPLOY_URL","DEPLOY_PRIME_URL","DEPLOY_ID"]),layerci:y(["LAYERCI_JOB_ID","LAYERCI_RUNNER_ID","RETRY_INDEX","LAYERCI_PULL_REQUEST","LAYERCI_REPO_NAME","LAYERCI_REPO_OWNER","LAYERCI_BRANCH","GIT_TAG"])}),ma=()=>{let{env:e}=process;return{appveyor:{sha:e.APPVEYOR_REPO_COMMIT,branch:e.APPVEYOR_PULL_REQUEST_HEAD_REPO_BRANCH||e.APPVEYOR_REPO_BRANCH,message:Zi(`
`,e.APPVEYOR_REPO_COMMIT_MESSAGE,e.APPVEYOR_REPO_COMMIT_MESSAGE_EXTENDED),authorName:e.APPVEYOR_REPO_COMMIT_AUTHOR,authorEmail:e.APPVEYOR_REPO_COMMIT_AUTHOR_EMAIL},awsCodeBuild:{sha:e.CODEBUILD_RESOLVED_SOURCE_VERSION,remoteOrigin:e.CODEBUILD_SOURCE_REPO_URL},azure:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR,authorEmail:e.BUILD_REQUESTEDFOREMAIL},bamboo:{sha:e.bamboo_planRepository_revision,branch:e.bamboo_planRepository_branch,authorName:e.bamboo_planRepository_username,remoteOrigin:e.bamboo_planRepository_repositoryURL},bitbucket:{sha:e.BITBUCKET_COMMIT,branch:e.BITBUCKET_BRANCH},buildkite:{sha:e.BUILDKITE_COMMIT,branch:e.BUILDKITE_BRANCH,message:e.BUILDKITE_MESSAGE,authorName:e.BUILDKITE_BUILD_CREATOR,authorEmail:e.BUILDKITE_BUILD_CREATOR_EMAIL,remoteOrigin:e.BUILDKITE_REPO,defaultBranch:e.BUILDKITE_PIPELINE_DEFAULT_BRANCH},circle:{sha:e.CIRCLE_SHA1,branch:e.CIRCLE_BRANCH,authorName:e.CIRCLE_USERNAME,remoteOrigin:e.CIRCLE_REPOSITORY_URL},codeshipBasic:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeshipPro:{sha:e.CI_COMMIT_ID,branch:e.CI_BRANCH,message:e.CI_COMMIT_MESSAGE,authorName:e.CI_COMMITTER_NAME,authorEmail:e.CI_COMMITTER_EMAIL},codeFresh:{sha:e.CF_REVISION,branch:e.CF_BRANCH,message:e.CF_COMMIT_MESSAGE,authorName:e.CF_COMMIT_AUTHOR},drone:{sha:e.DRONE_COMMIT_SHA,branch:e.DRONE_SOURCE_BRANCH,message:e.DRONE_COMMIT_MESSAGE,authorName:e.DRONE_COMMIT_AUTHOR,authorEmail:e.DRONE_COMMIT_AUTHOR_EMAIL,remoteOrigin:e.DRONE_GIT_HTTP_URL,defaultBranch:e.DRONE_REPO_BRANCH},githubActions:{sha:e.GITHUB_SHA,branch:e.GH_BRANCH||e.GITHUB_REF,defaultBranch:e.GITHUB_BASE_REF,remoteBranch:e.GITHUB_HEAD_REF,runAttempt:e.GITHUB_RUN_ATTEMPT},gitlab:{sha:e.CI_COMMIT_SHA,branch:e.CI_COMMIT_REF_NAME,message:e.CI_COMMIT_MESSAGE,authorName:e.GITLAB_USER_NAME,authorEmail:e.GITLAB_USER_EMAIL,remoteOrigin:e.CI_REPOSITORY_URL,defaultBranch:e.CI_DEFAULT_BRANCH},googleCloud:{sha:e.COMMIT_SHA,branch:e.BRANCH_NAME},jenkins:{sha:e.GIT_COMMIT,branch:e.GIT_BRANCH},semaphore:{sha:e.SEMAPHORE_GIT_SHA,branch:e.SEMAPHORE_GIT_BRANCH,remoteOrigin:e.SEMAPHORE_GIT_REPO_SLUG},shippable:{sha:e.COMMIT,branch:e.BRANCH,message:e.COMMIT_MESSAGE,authorName:e.COMMITTER},snap:null,teamcity:null,teamfoundation:{sha:e.BUILD_SOURCEVERSION,branch:e.BUILD_SOURCEBRANCHNAME,message:e.BUILD_SOURCEVERSIONMESSAGE,authorName:e.BUILD_SOURCEVERSIONAUTHOR},travis:{sha:e.TRAVIS_PULL_REQUEST_SHA||e.TRAVIS_COMMIT,branch:e.TRAVIS_PULL_REQUEST_BRANCH||e.TRAVIS_BRANCH,message:e.TRAVIS_COMMIT_MESSAGE},wercker:null,netlify:{sha:e.COMMIT_REF,branch:e.BRANCH,remoteOrigin:e.REPOSITORY_URL},layerci:{sha:e.GIT_COMMIT,branch:e.LAYERCI_BRANCH,message:e.GIT_COMMIT_TITLE}}},Ys=e=>{let t=zs();return t?(0,S.chain)(e()).get(t).value():{}};function fa(){return(0,S.chain)(Js()).omitBy(S.isNull).keys().value()}function zs(){let e=da();return Oe("detected CI provider name: %s",e),e||null}function ha(){return Ys(Js)}function Qs(){return Ys(ma)}function Ea(e){return e&&fa().includes(e)}function Xs(e){let t=ha(),r=zs(),n=Ia(e,r);return Oe("detected CI provider: %s",r),Oe("detected CI params: %O",t),Oe("detected CI build ID: %o",n),{params:t,provider:r,ciBuildId:n}}function Ia(e,t){return e?{source:"user",value:e}:Ea(t)?{source:"server",value:null}:{source:"random",value:`auto:${it()}`}}var Lr=l.extend("ci-git");function Zs(e){Lr("git commit existing info: %O",e);let t=Qs();Lr("commit info from provider environment variables: %O",t);let r=(0,Ne.transform)(e,(n,s,o)=>{let a=s||(t?t[o]:null);return n[o]=(0,Ne.defaultTo)(a,null)});return Lr("combined git and environment variables from provider: %O",r),r}var Ca=async()=>{let e=await(0,to.commitInfo)();return Zs({branch:e.branch,remoteOrigin:e.remote,authorEmail:e.email,authorName:e.author,message:e.message,sha:e.sha,ghaEventData:e.ghaEventData})},Ue=(0,eo.memoize)(Ca);var Fr=l.extend("fixture"),Dr=async function(e,t){let r;try{r=await V.upsertState("fixtureGitInfo",async()=>await Ue())}catch(n){Fr("Failed to retrieve git info",n)}Fr("Git info",r),e&&await e(r)},ro=async({currentsFixturesEnabled:e},t,r)=>{if(!e)return Fr("Currents fixtures disabled, skipping git info fixture"),await t();await Dr(t,r)};i();E();var no=l.extend("fixture"),Mr=async function(e,t,r=null,n=null){let s=await V.getState("projectRules");if(!s){no("No actions found, skipping actions processing"),await e(n||{});return}s.applyBefore(t,r),await e(n||s.rules),s.applyAfter(t,r)},so=async({gitInfo:e,currentsFixturesEnabled:t},r,n)=>{if(!t)return no("Currents fixtures disabled, skipping action fixture"),await r({});await Mr(r,n,e)};i();j();E();i();var oo=g(require("crypto"));function ct(e){return typeof e=="string"&&(e=Buffer.from(e)),oo.default.createHash("md5").update(e).digest("hex")}i();var fo=require("axios"),ho=g(require("json-stringify-safe"));E();R();i();at();function io(e){return L({method:"GET",url:`/rules/project/${e}`,"axios-retry":{retries:1}}).then(t=>t.data)}i();var N={EQ:"eq",NEQ:"neq",IN:"in",NOTIN:"notIn",ANY:"any",EMPTY:"empty",INC:"inc",NOTINC:"notInc",INCALL:"incAll",NOTINCALL:"notIncAll"},ao=[N.EMPTY,N.NEQ,N.NOTIN,N.NOTINC,N.NOTINCALL],q={SKIP:"skip",QUARANTINE:"quarantine",TAG:"tag"};i();var mo=require("lodash");i();var uo=g(require("lodash")),co=e=>Array.isArray(e)?e.length>0:!!e,Le=(e,t)=>Array.isArray(e)||Array.isArray(t)?uo.default.xor([e].flat(),[t].flat()).length===0:e===t,qt=(e,t)=>{if(Array.isArray(t)||Array.isArray(e)){let r=[e].flat(),n=[t].flat();for(let s=0,o=0,a=!1;s<n.length;){let u=qt(r[o],n[s]);if(u){s++,o=0;continue}if(a=a||!u,o<r.length)o++;else{if(a)return!1;o=0,s<n.length&&s++}}return!0}return typeof t=="string"&&typeof e=="string"?new RegExp(t).test(e):Le(e,t)},Br=(e,t)=>{if(Array.isArray(t)||Array.isArray(e)){let r=[e].flat(),n=[t].flat();for(let s=0,o=0;s<n.length;){if(qt(r[o],n[s]))return!0;o<r.length?o++:(o=0,s<n.length&&s++)}return!1}return Le(e,t)},lo=(e,t)=>{let r=new Set([e].flat());return[t].flat().every(n=>r.has(n))},kr=(e,t)=>{let r=new Set([e].flat());return[t].flat().some(n=>r.has(n))},po=(e,t)=>Array.isArray(e)?kr(e,t):new Set([t].flat()).has(e);i();function Kt(e){return typeof e=="string"?go(e):Array.isArray(e)?e.map(go):e}function go(e){return e.startsWith("@")?e:`@${e}`}var Jt=({input:e,toMatch:t,op:r,allowRegex:n})=>{let s=(()=>{switch(r){case N.ANY:case N.EMPTY:return co(e);case N.EQ:case N.NEQ:return n?qt(e,t):Le(e,t);case N.IN:case N.NOTIN:return n?Br(e,t):po(e,t);case N.INC:case N.NOTINC:return n?Br(e,t):kr(e,t);case N.INCALL:case N.NOTINCALL:return n?qt(e,t):lo(e,t);default:return!1}})();return ao.includes(r)?!s:s},Fe=class{constructor(t,r=(n,...s)=>{}){this.rules=t;this._debug=r}matchCondition(t,r){switch(t.type){case"title":case"titlePath":case"file":{let n={input:r[t.type],toMatch:t.value,op:t.op,allowRegex:!0},s=Jt(n);return this._debug("Check condition type %s : %O and got result %s",t.type,n,s),s}case"git_branch":case"git_authorName":case"git_authorEmail":case"git_remoteOrigin":case"git_message":{let n={input:r.gitInfo&&r.gitInfo[t.type.replace("git_","")],toMatch:t.value,op:t.op,allowRegex:!0},s=Jt(n);return this._debug("Check condition type %s : %O and got result %s",t.type,n,s),s}case"project":case"testId":{let n={input:r[t.type],toMatch:t.value,op:t.op,allowRegex:!1},s=Jt(n);return this._debug("Check condition type %s %O and got result %s",t.type,n,s),s}case"tag":{let n=r[t.type]!==void 0?Kt(r[t.type]):void 0,s=t.value!==null?Kt(t.value):null,o={input:n,toMatch:s,op:t.op,allowRegex:!1},a=Jt(o);return this._debug("Check condition type %s %O and got result %s",t.type,o,a),a}case"error_message":{let n=r.errors?.map(u=>u.message),s=t.value,o={input:n,toMatch:s,op:t.op,allowRegex:!0},a=Jt(o);return this._debug("Check condition type %s %O and got result %s",t.type,o,a),a}default:return!1}}matchRule(t,r){return this._debug("Check for rule match %j with test %O",t,r),t.matcher.op==="AND"?t.matcher.cond.every(n=>this.matchCondition(n,r)):t.matcher.op==="OR"?t.matcher.cond.some(n=>this.matchCondition(n,r)):!1}getMatchedRules(t){return this.rules.filter(r=>this.matchRule(r,t))}getMatchedRulesGroupedByType(t){let r=this.rules.filter(n=>this.matchRule(n,t));return(0,mo.groupBy)(r,n=>n.action[0].op)}};i();var Ra=new RegExp("([\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:[a-zA-Z\\d]*(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)|(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-ntqry=><~])))","g");function De(e){return e.replace(Ra,"")}i();var At=l.extend("fixture"),xt=class extends Fe{constructor(r){super(r,At);this.rules=r}testInfoToMatchable(r,n){return{title:r.title,titlePath:r.titlePath,file:r.titlePath[0],project:r.project.name,testId:r.testId,tag:r.tags,gitInfo:n,errors:r.errors?.filter(s=>!!s.message).map(s=>({message:De(s.message)}))}}markMatchedTest(r,n){try{let s=this.getMatchedRulesGroupedByType(n);for(let[o,a]of Object.entries(s)){if(a.length==0)return;At("Test matched an action. Matchable: %O, ActionType: %s, Actions: %j",n,o,a);let u=Me({actionType:o,testInfo:r,action:a[0]});r.annotations.push({type:Y.ACTION_MATCH,description:JSON.stringify(u)})}}catch(s){d("Failed to mark a test with matching actions",s)}}applyBefore(r,n){let s=this.testInfoToMatchable(r,n);this.markMatchedTest(r,s);let o=[];try{o=this.getMatchedRules(s),o.length>0&&At("Test matched after before. %O Actions : %j",s,o),this.attachMatchedActions(r,Wt.BEFORE,o)}catch(u){d("Failed to apply before actions",u)}if(o.length===0)return;o.filter(u=>u.action.some(p=>p.op===q.SKIP)).some(u=>{r.annotations.push({type:Y.ACTION_SKIP,description:JSON.stringify(Me({actionType:q.SKIP,testInfo:r,action:u}))}),r.skip(!0,`Skipping due to matched Currents.dev skip action: ${u.name}`)})}applyAfter(r,n){let s=[];try{let a=this.testInfoToMatchable(r,n);s=this.getMatchedRules(a),s.length>0&&At("Test matched after rules. %O Actions : %j",a,s),this.attachMatchedActions(r,Wt.AFTER,s)}catch(a){d("Failed to apply after action",a)}if(s.length===0)return;s.filter(a=>a.action.some(u=>u.op===q.QUARANTINE)).some(a=>{r.expectedStatus!==r.status&&(At("Quarantining test, status was: %s",r.status),r.annotations.push({type:Y.ACTION_QUARANTINE,description:JSON.stringify(Me({actionType:q.QUARANTINE,testInfo:r,action:a,extraDetails:{status:r.status}}))}),r.status="skipped",r.skip(!0,`Quarantining due to matched Currents.dev action: ${a.name}`))})}attachMatchedActions(r,n,s){try{if(s.length===0)return;r.attach(n,{body:Buffer.from((0,ho.default)(s))})}catch(o){d("Failed to attach reporter action",o)}}static applyReporter(r,n,s){s.flatMap(a=>a.action.map(u=>({action:u,rule:a}))).filter(a=>a.action.op===q.TAG).forEach(a=>{let u=Kt(a.action.details?.tags||[]);n.annotations.push({type:Y.ACTION_TAG,description:JSON.stringify(Me({actionType:q.TAG,testInfo:{config:r,testId:n.id},action:a.rule,extraDetails:{tags:u}}))}),n._tags||(n._tags=[]),n._tags.push(...u)})}},Me=e=>{let{actionType:t,testInfo:r,action:n,extraDetails:s}=e;return{rule:{v:n.v,id:n._id,name:n.name,type:t,extraDetails:s,appliedAt:Date.now()},testInfo:{config:{version:r.config.version},testId:r.testId,status:s?.status}}},Eo=async e=>{try{let t=await io(e);return new xt(t.rules)}catch(t){return At("Failed to fetch project actions: %o",(0,fo.isAxiosError)(t)?t.toJSON():t),d("Failed to fetch project actions"),new xt([])}};i();i();j();E();R();i();var Io=require("c12");function Co(e){return(0,Io.loadConfig)({name:"currents",configFile:e})}i();R();function To(e=()=>!1){let t=Date.now(),r=ya();for(;!e();)if(Date.now()-t>r)throw _(`Could not load Currents config after ${r}ms, exiting...`),new Error("Could not load Currents config")}function ya(e=5e3){let t=Number(process.env.CURRENTS_CONFIG_LOAD_TIMEOUT_MS);return isNaN(t)||t<1?e:t}var Ro=l.extend("config-loader"),Pt=class{constructor(t,r=o=>{},n=()=>{process.exit(1)},s={validationFn:ir}){this.reporterOptions=t;this.onSuccess=r;this.onFailure=n;this.options=s;this._configLoaded=!1;this._promise=null}start(){return this._promise=Co(yt().pwcConfigPath).then(async t=>{this.onSuccess(t),xn(this.reporterOptions,t.config,{validationFn:this.options.validationFn})}).catch(t=>{_("Could not load currents configuration: %O",t),this.onFailure()}).finally(()=>{this._configLoaded=!0}),this}waitSync(){return Ro("Waiting to load config..."),To(()=>this._configLoaded),this}load(){return this._promise||(Ro("Starting config loader"),this.start()),this._promise}};i();function z(e){return e!=null}i();var yo=g(require("fs"));E();var jr=l.extend("fixture:worker-config:run-if-no-marker");async function _o(e){let t=Or(Ht.FIXTURES_CONFIG_ERR_FILE);if(jr("Checking if error marker exists",t),yo.default.existsSync(t))return jr("Error file exists, skipping config loader"),!1;try{return await e(),!0}catch(r){return $s(t,r),jr("Failed to load config",r),!1}}async function So(e){let t=[],r=await _o(async()=>{await V.upsertState("fixtureConfigLoader",new Pt(e,()=>{},()=>{},{validationFn:n=>t=_a(n)})).load()});return{missingKeys:t,loaded:r}}function _a(e){return["projectId","recordKey"].map(t=>e[t]?null:t).filter(z)}var Ao=l.extend("fixture:worker-config"),$r=async function({config:e,use:t,workerInfo:r,chainedFixture:n=null}){try{let{missingKeys:o,loaded:a}=await So(e);if(!a){St("fixture:worker-config:not-loaded",["Failed to load Currents config"]),await t(n);return}if(o.length>0){St(ct(`missing_config_keys_${o.join("-")}`),o.map(u=>`Missing Currents configuration: "${u}". Currents Fixtures may not work as expected.`)),await t(n);return}}catch(o){Ao("Failed to load config",o),St(ct("fixture:worker-config:exception"),["Error loading Currents configuration. Currents Fixtures may not work as expected."]),await t(n);return}let s=w();s&&await V.populateState("projectRules",Eo(s.projectId)),await t(n||s)},xo=async({currentsConfigOptions:e,currentsFixturesEnabled:t},r,n)=>{if(!t)return Ao("Currents fixtures are disabled, skipping config fixture"),await r(null);await $r({config:e,use:r,workerInfo:n})};var Po={currentsFixturesEnabled:[!0,{scope:"worker",option:!0}],currentsConfigOptions:[{},{scope:"worker",option:!0}],gitInfo:[ro,{scope:"worker",title:"Currents Git Info"}],currentsConfig:[xo,{scope:"worker",auto:!0,title:"Currents Configuration"}]},wo={currentsActions:[so,{auto:!0,scope:"test",title:"Currents Actions"}]},bo={context:[Ks,{scope:"test",title:"Currents Coverage"}]};i();var Sa=(e,t=null)=>async function({launchOptions:r},n,s){await Promise.all([Dr(null,s),$r({config:e,use:n,workerInfo:s,chainedFixture:t??r})])},Aa=(e=null)=>async function({contextOptions:t},r,n){let s=await V.getState("fixtureGitInfo");await Mr(r,n,s,e??t)},vo=(e={})=>e.currentsFixturesEnabled===!1?e:{...e,launchOptions:Sa(e.currentsConfigOptions||{},e.launchOptions),contextOptions:Aa(e.contextOptions)};i();i();var Ei=g(require("fs")),ze=require("ts-pattern");i();var Be=require("lodash"),Fo=g(require("p-queue")),Do=g(require("path")),lt=require("ts-pattern"),Gr=require("util");E();R();Sr();i();at();function Oo(e,t){return L({method:"POST",url:`/artifacts/test-record/${e}`,data:{...t,_t:Date.now()}}).then(r=>r.data)}function No(e,t){return L({method:"POST",url:`/artifacts/instance/${e}`,data:{...t,_t:Date.now()}}).then(r=>r.data)}var U=l.extend("artifact"),Vr=l.extend("upload-queue"),Q=new Fo.default({concurrency:20}),xa=0,Pa=0;Q.on("active",()=>{Vr(`Working on item #${++xa}.  Size: ${Q.size}  Pending: ${Q.pending}`)});Q.on("add",()=>{Vr(`Added item #${++Pa}.  Size: ${Q.size}  Pending: ${Q.pending}`)});var Hr=class{constructor(t,r,n,s,o,a){this.testLabel=t;this.testId=r;this.attemptId=n;this.groupId=s;this.artifactId=o;this.artifact=a;this.recordId=null;this.instanceId=null;this.runId=null;this.machineId=null;this.uploadPromise=Promise.resolve();this.uploadedAt=null;this.uploadStartedAt=null;this.createdAt=new Date}startUpload(){let t=async()=>{try{if(!this.recordId)throw new Error("recordId must be set before uploading");if(!this.instanceId)throw new Error("instanceId must be set before uploading");if(!this.runId)throw new Error("runId must be set before uploading");if(!this.machineId)throw new Error("machineId must be set before uploading");U("Creating artifact %o",this.getDebugInfo());let r=await Oo(this.recordId,{createdAt:this.createdAt,type:this.artifact.type,name:this.artifact.name,filename:this.artifact.filename,runId:this.runId,groupId:this.groupId,instanceId:this.instanceId,machineId:this.machineId,testId:this.testId,artifactId:this.artifactId,attemptId:this.attemptId,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name);return}this.uploadedAt=new Date,await Mo(this.artifact,r.uploadUrl),U("Upload completed for test record artifact: %o",this.getDebugInfo())}catch(r){U("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for test record artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=Q.add(t),this}setRecordId(t,r,n,s){if(this.recordId){U("Record id already set for artifact: %o",this.getDebugInfo());return}U("Starting test record artifact upload: %o",this.getDebugInfo()),this.recordId=t,this.instanceId=r,this.runId=n,this.machineId=s,this.startUpload()}getDebugInfo(){return{testLabel:this.testLabel,recordId:this.recordId,attemptId:this.attemptId,attachment:this.artifact.path??this.artifact.name}}},Wr=class{constructor(t,r,n,s){this.instanceId=t;this.groupId=r;this.runId=n;this.artifact=s;this.uploadPromise=Promise.resolve()}startUpload(){let t=async()=>{try{U("Creating instance artifact %o",this.getDebugInfo());let r=await No(this.instanceId,{name:this.artifact.name,runId:this.runId,groupId:this.groupId,type:this.artifact.type,contentType:this.artifact.contentType,metadata:this.artifact.metadata});if(!r?.uploadUrl){d("Could not get upload instructions for instance %s artifact %s",this.instanceId,this.artifact.path??this.artifact.name);return}await Mo(this.artifact,r.uploadUrl),U("Upload completed for instance artifact: %o",this.getDebugInfo())}catch(r){U("Error creating artifact: %o",r,this.getDebugInfo()),d("Could not get upload instructions for instance artifact %s",this.artifact.path??this.artifact.name)}};return this.uploadPromise=Q.add(t),this}getDebugInfo(){return{instanceId:this.instanceId,attachment:this.artifact.path??this.artifact.name}}},b=class{static{this.uploads=new Map}static{this.ids=new Map}static{this.uploadWarnings=new Set}static createOnceForAttempt(t){return t.attachment.forEach((r,n)=>{this._createOnceForAttempt({...t,attachmentIndex:n},r)}),this}static createOnceForInstance(t){return t.artifact.forEach((r,n)=>{let s=this.getArtifactId({testId:`${t.instanceId}-${t.type}`,attemptId:0,attachment:r,attachmentIndex:n});if(this.uploads.has(s)){U("Instance artifact uploader already exists for %o",{instanceId:t.instanceId,attachment:r.path??r.name});return}let o=new Wr(t.instanceId,t.groupId,t.runId,r).startUpload();U("Creating instance artifact uploader %o",{instanceId:t.instanceId,attachment:r.path??r.name}),this.uploads.set(s,o)}),this}static setRecordId(t,r,n,s,o){this.ids.has(t)||(U("Triggering pending uploads for test record %s",r),this.ids.set(t,{recordId:r,instanceId:n,runId:s,machineId:o}),this.uploads.forEach(a=>{"testId"in a&&a.testId===t&&a.setRecordId(r,n,s,o)}))}static getAllUploads(){return Array.from(this.uploads.values()).map(t=>t.uploadPromise)}static dumpUploads(){let t=[],r=[];this.uploads.forEach(n=>{n.recordId&&t.push({recordId:n.recordId,testLabel:n.testLabel,testId:n.testId,attemptId:n.attemptId,name:n.artifact.name,uploadedAt:n.uploadedAt,promise:n.uploadPromise}),n.instanceId&&r.push({instanceId:n.instanceId,name:n.artifact.name,promise:n.uploadPromise})}),Vr("Queue size:",Q.size),console.table((0,Be.orderBy)(t,"recordId")),console.table(r)}static getArtifactId(t){let r=t.attachmentIndex??t.attachment.path??t.attachment.name,n=ct(Buffer.from(`${t.testId}-${t.attemptId}-${r}`));return U("Artifact id %s for %o",n,{testId:t.testId,attemptId:t.attemptId,attachmentIndex:t.attachmentIndex,path:t.attachment.path,name:t.attachment.name}),n}static _createOnceForAttempt(t,r){let{testLabel:n,testId:s,attemptId:o,groupId:a}=t,u=r.path??r.name,p=this.getArtifactId({testId:s,attemptId:o,attachment:r,attachmentIndex:t.attachmentIndex??0});if(this.uploads.has(p))return U("Artifact uploader already exists for %o",{testLabel:n,key:p,attachmentLabel:u,attemptId:o}),this;let h=new Hr(n,s,o,a,p,{...r,name:r.name,type:Oa(r),filename:Na(r)});U("Creating artifact uploader %o",{key:p,testLabel:n,attachmentLabel:u}),this.uploads.set(p,h);let C=this.ids.get(s);return C&&h.setRecordId(C.recordId,C.instanceId,C.runId,C.machineId),this}};async function Mo(e,t){try{await(0,lt.match)(e).with({path:lt.P.string},r=>Ce({name:r.name,path:r.path,uploadUrl:t,contentType:e.contentType},e.contentType,Uo(r.path))).with({body:lt.P.not(lt.P.nullish)},r=>_r({name:r.name,buffer:r.body,uploadUrl:t,contentType:e.contentType},e.contentType,Uo(r.name??"buffer"))).otherwise(()=>{let r=(0,Gr.format)("Unknown attachment type: %o",e);d(r),b.uploadWarnings.add(r)})}catch(r){let n=(0,Gr.format)("Upload failed: %o",wa(r));b.uploadWarnings.add(n),d(n)}}var Uo=e=>({total:t,loaded:r})=>{};function Lo(e){return e/1e3/1e3}function wa(e){return(0,Be.pick)(e,"message","code","method","url")}function ba(e){return e.subarray(0,8).toString("hex").toUpperCase()}function va(e){return Object.values({jpeg:"FFD8FF",png:"89504E470D0A1A0A",gif87a:"474946383761",gif89a:"474946383961",bmp:"424D",tiffLE:"49492A00",tiffBE:"4D4D002A"}).some(r=>e.startsWith(r))}function Oa(e){return(0,lt.match)(e).when(({contentType:t,body:r})=>{if(t.startsWith("image"))return!0;if(r&&t==="application/octet-stream"){let n=ba(r);return va(n)}return!1},()=>"screenshot").when(({contentType:t})=>t.startsWith("video"),()=>"video").when(({name:t,path:r,contentType:n})=>n==="application/zip"&&t==="trace"&&!!r,()=>"trace").when(({name:t,path:r,contentType:n})=>n==="application/json"&&t==="coverage"&&!!r,()=>"coverage").otherwise(()=>"attachment")}function Na(e){return e.path&&Do.default.basename(e.path)}ar();E();i();var Bo=require("@babel/code-frame"),ke=g(require("chalk")),Kr=g(require("fs")),wt=g(require("path")),ko=g(require("stack-utils")),jo=g(require("url"));function qr(e,t){return e.replace(/^(?=.+$)/gm,t)}function Ua(e){let t=e.split(`
`),r=t.findIndex(a=>a.startsWith("    at "));r===-1&&(r=t.length);let n=t.slice(0,r).join(`
`),s=t.slice(r),o;for(let a of s){let{frame:u,fileName:p}=Ma(a);if(!(!u||!p)&&!La(p)){o={file:p,column:u.column||0,line:u.line||0};break}}return{message:n,stackLines:s,location:o}}function La(e){return e.includes(`${wt.default.sep}node_modules${wt.default.sep}`)}function Fa(e,t){return wt.default.relative(e.rootDir,t)||wt.default.basename(t)}function Jr(e,t,r,n){let s=t.stack,o=[],a;if(s){let u=Ua(s);if(o.push(u.message),a=u.location,a)if(!t.snippet&&(!n||Kr.default.realpathSync(n)!==a.file)&&(o.push(""),o.push(ke.default.gray("   at ")+`${Fa(e,a.file)}:${a.line}`)),o.push(""),t.snippet)o.push(t.snippet);else try{let p=Kr.default.readFileSync(a.file,"utf8"),h=(0,Bo.codeFrameColumns)(p,{start:a},{highlightCode:r});o.push(h)}catch{}o.push(""),o.push(u.stackLines.join(`
`))}else t.message?o.push(t.message):t.value&&o.push(t.value);return{location:a,message:o.join(`
`)}}var Da=new ko.default;function Ma(e){let t=Da.parseLine(e);if(!t)return{frame:null,fileName:null};let r=null;return t.file&&(r=t.file.startsWith("file://")?jo.default.fileURLToPath(t.file):wt.default.resolve(process.cwd(),t.file)),{frame:t,fileName:r}}function $o(e,t,r,n,s){let o=[];r.status==="passed"&&t.expectedStatus==="failed"&&o.push({message:qr(ke.default.red("Expected to fail, but passed."),n)}),r.status==="interrupted"&&o.push({message:qr(ke.default.red("Test was interrupted."),n)});for(let a of r.errors){let u=Jr(e,a,s,t.location.file);o.push({message:qr(u.message,n),location:u.location})}return o}Rr();Xe();pr();R();re();i();var Go=g(require("fs"));E();R();var ld=l.extend("output");async function Ho(e){let t=" ".repeat(e.options?.ident??2);P(`${t}\u{1F4BE} JSON output file: ${m(e.outputFile)}`);try{Go.default.writeFileSync(e.outputFile,JSON.stringify(e.summary,null,2))}catch(r){_("Error writing JSON summary",r.message)}}br();i();var k=require("lodash"),on=g(require("pluralize"));j();E();i();i();j();i();E();i();E();i();i();E();at();var je=class{static create(t){return l("Creating instance: %o",t),L({method:"POST",url:`runs/${t.runId}/pw/instances/v1`,data:t}).then(r=>r.data)}};i();E();re();var Yr=l.extend("instance"),zr=class{constructor(t,r,n){this.projectId=t;this.specName=r;this.tests=n;this.claimedCount=0;this.instanceId=null;this.creationRequest=null}async startCreationOnce({run:t,startTime:r,worker:n}){return this.creationRequest?this.creationRequest:(this.creationRequest=t.then(s=>s?je.create({runId:s.runId,groupId:s.groupId,machineId:s.machineId,spec:this.specName,worker:n,startTime:r}).then(({instanceId:o,claimedCount:a})=>(Yr("Create instance response: %o",{worker:n,projectId:this.projectId,specName:this.specName,instanceId:o,claimedCount:a}),this.instanceId=o,this.claimedCount=a,{instanceId:o,claimedCount:a})).catch(o=>(st.push("Failed to create instance for project %s, spec file %s: %s",this.projectId,this.specName,o),null)):(Yr("Missing run to create instance [%s] > %s",this.projectId,this.specName),null)),this.creationRequest)}},Yt=class e{static{this.instanceCreations=new Map}static get(t,r){return e.instanceCreations.get(e.getKey(t,r))}static createOnce(t,r,n){let s=e.getKey(t,r),o=e.instanceCreations.get(s);if(o)return Yr("Instance creation already started: %s %s",t,r),o;let a=new zr(t,r,n);return e.instanceCreations.set(s,a),a}static getKey(t,r){return`${t}::${r}`}};R();R();i();var G=require("lodash"),Xr=g(require("path")),$e=g(require("pluralize")),Ge=g(require("pretty-ms")),Zr=require("process"),Qt=require("ts-pattern");j();ur();Ze();R();i();var Wo=require("lodash"),Vo=require("ts-pattern");function Ba(e){if(!e.results?.length)return"skipped";let t=e.results.map(r=>r.status);return t.every(r=>r===t[0])?(0,Vo.match)(t[0]).with("skipped",()=>"skipped").with("passed",()=>e.expectedStatus==="passed"?"passed":"failed").with("failed",()=>e.expectedStatus==="failed"?"passed":"failed").otherwise(()=>"failed"):e.results.some(r=>r.status==="passed")&&e.expectedStatus==="passed"||e.results.some(r=>r.status==="failed")&&e.expectedStatus==="failed"?"passed":e.results.some(r=>r.status==="skipped")&&e.expectedStatus==="skipped"?"skipped":"failed"}function Qr(e){switch(e){case"timedOut":return"failed";case"interrupted":return"failed";case"skipped":return"pending";default:return e}}var pt=(0,Wo.flowRight)(Qr,Ba);var gt=class e{constructor(t,r,n,s=w(),o){this.pwConfig=t;this.suite=r;this.executionState=n;this.currentsConfig=s;this.ciBuildId=o;this.loggerChain=Promise.resolve(null);this.runUrl=null;this.runId=null;this.flakySymbol="flaky"}static{this.VISIBLE_TAG_LIMIT=10}static{this.globalOutput=new Map}static mergeOutputMaps(...t){let r=new Map;t.forEach(s=>{s.forEach((o,a)=>{r.set(a,o)})});let n=[];return Array.from(r.keys()).sort().forEach(s=>n.push(...r.get(s))),n}getIntro(){return[`\u{1F4E6} Currents reporter: ${m([`${X(ie)}`,`recording to project ${this.currentsConfig?.projectId}`].join(" "))}`,`\u{1F3AD} Playwright: ${m([`${X(this.pwConfig.version)}`,`${this.suite.allTests().length} ${(0,$e.default)("test",this.suite.allTests().length)} in ${this.suite.suites.length} ${(0,$e.default)("project",this.suite.suites.length)} [${this.suite.suites.map(t=>et(t.project())).join(", ")}]`,this.pwConfig.shard?["shard",`${this.pwConfig.shard.current}/${this.pwConfig.shard.total}`].join(" "):null].filter(t=>t).join(" "))} `,this.ciBuildId.value?"\u{1F528} CI Build ID: "+[`${X.dim(this.ciBuildId.value)}`,this.ciBuildId.source==="random"?[m("was auto-generated,"),m("learn more at"),fn(ee.guide.ciBuildId)].join(" "):null].filter(Boolean).join(" "):null].filter(t=>t).join(`
`)}onTestBegin(t){let r=this.executionState.getTestExecution(t),n=`${this.now()} ${X(`starting test attempt #${t.results.length}`)}: ${this.getTestCaseLabel(t)}`;r?.appendOutput([n]),this.logAfterRunCreated(n)}async onTestEnd(t,r){let n=Zr.hrtime.bigint(),s=this.executionState.getTestExecution(t);return this.getTestEndLines(t,r).then(o=>{s?.appendOutput(o,n),this.logAfterRunCreated(o.join(`
`))})}getTagStdout(t){return t.tags.length?["  Tag:",m(t.tags.length>e.VISIBLE_TAG_LIMIT?(0,G.take)(t.tags,e.VISIBLE_TAG_LIMIT).join(", ")+` +${t.tags.length-e.VISIBLE_TAG_LIMIT} more...`:t.tags.join(", "))].join(" "):null}async getTestEndLines(t,r){let n=`finished test attempt #${r.retry+1}`,s=this.executionState.getTestExecution(t),o=await this.executionState.getDashboardUrl(),a=o?await s?.getTestLink(o):null;return[`${this.now()} ${X(`${n}`)}: ${this.getTestCaseLabel(t)}`,[a?["  Recording URL:",m(a)].join(" "):null,this.getTagStdout(t),["  Expected result:",m(t.expectedStatus)].join(" "),t.results.map((p,h)=>[`    - attempt ${h+1}/${t.retries+1}:`,m(p.status),m(`${(0,Ge.default)(p.duration)}`)].join(" ")).join(`
`)].filter(Boolean).join(`
`),t.results.length===0?m("    - No attempts"):null,r.retry>t.retries?m("    \u2139\uFE0F  Note: retries can exceed max attempts when serial mode is enabled"):null,s?.isFinished()?["  Test result:",this.getStatusLabel(s.currentsState),...s?.isFlaky?[jt(this.flakySymbol)]:[]].join(" "):m("    - waiting for additional attempts to determine test result..."),...this.getInlineErrorsBlock(t,r),"",Ct(),""].filter(p=>p!==null)}onStdOut(...t){this.onOutput("stdout",...t)}onStdErr(...t){this.onOutput("stderr",...t)}onOutput(t,r,n,s){let a=[this.getStdIdentifier(t,n,s),(r??"<empty>").toString()].join(`
`);n?this.executionState.getTestExecution(n)?.appendOutput([a]):e.globalOutput.set(Zr.hrtime.bigint(),[a]),this.logAfterRunCreated(a)}getStdIdentifier(t,r,n){let s=[this.now(),X(`${t} from:`)];return r?s.push(this.getTestCaseLabel(r)):s.push("global output - no tests associated"),n&&s.push(`- attempt #${n.retry+1}`),s.join(" ")}getInlineErrorsBlock(t,r){if(this.executionState.getTestExecution(t)?.isFlaky||pt(t)==="failed"){let s=t.results.filter(o=>o.error);if(s.length)return s.flatMap(o=>["",`  ${dn(`attempt ${o.retry+1} error`)}`,...this.getTestResultError(t,o),`  ${mn(`attempt ${o.retry+1} error`)}`,""])}return[]}async onEnd(t){await this.printSummary(t,this.executionState.getAllTestExecutions())}farewell(t,r){let n=[];n.push(`  Elapsed time: ${m((0,Ge.default)(Date.now()-t.getTime()))}`,`  Artifacts created: ${m(r)}`),this.runUrl&&!W()&&n.push(`  \u{1F310} Run URL: ${m(this.runUrl)}`),this.logAfterRunCreated(n.join(`
`))}chainRunCreation(){Object.values(this.executionState.projectExecutions).length&&(this.loggerChain=this.loggerChain.then(()=>Promise.allSettled([this.executionState.getRunUrl(),this.executionState.getRunId(),this.executionState.getCiBuildId()])).then(([r,n,s])=>{this.runUrl=r.status==="fulfilled"?r.value:null,this.runId=n.status==="fulfilled"?n.value:null;let o=s.status==="fulfilled"?s.value:null;this.runUrl?(o&&this.ciBuildId.source==="server"&&P("\u{1F528} CI Build ID: %s %s",X.dim(o),m("auto-detected")),P("\u{1F310} Run URL: %s",m(this.runUrl)),It()):d("Failed to create run recording")}))}now(){return m(new Date().toISOString())}getStatusLabel(t){let r=this.getColor(t),n=(0,Qt.match)(t).when(s=>s==="passed",()=>"passed").when(s=>s==="failed",()=>"failed").when(s=>s==="skipped",()=>"failed").when(s=>s==="pending",()=>"skipped").otherwise(()=>"unknown");return r(n)}getColor(t){return(0,Qt.match)(t).when(r=>r==="passed",()=>Bt).when(r=>r==="failed",()=>Tt).when(r=>r==="skipped",()=>Tt).when(r=>r==="pending",()=>kt).otherwise(()=>G.identity)}getTestCaseLabel(t,r=!0){let n=Pe(t).location.file;return[r?`[${tt(t)}]`:null,t.location.file!==n?this.relativeFilePath(this.pwConfig,n):null,this.getTestCaseFile(t),A(t).join(" \u203A ")].filter(s=>s).join(" \u203A ")}getTestCaseFile(t,r=!0){let n=this.relativeTestPath(this.pwConfig,t);return t.location&&r?`${n}:${t.location.line}:${t.location.column}`:n}relativeTestPath(t,r){return this.relativeFilePath(t,r.location.file)}relativeFilePath(t,r){return Xr.default.relative(t.rootDir,r)||Xr.default.basename(r)}getTestResultError(t,r){return $o(this.pwConfig,t,r,"  ",!0).map(n=>`
`+n.message+`
`)}getBriefAttachments(t){let r=t.results.flatMap(s=>({attempt:s.retry,attachments:s.attachments}));if(!r.flatMap(s=>s.attachments).length)return[];let n=["  Attachments:"];return(0,G.orderBy)(r,"attempt").forEach(({attachments:s,attempt:o})=>{if(n.push(`    - attempt #${o+1}`),!s.length){n.push(m("       - no attachments"));return}let a=(0,G.groupBy)(s,u=>this.getAttachmentType(u));n.push(`       ${s.length} ${(0,$e.default)("attachment",s.length)}: ${Object.entries(a).map(([u,p])=>`${p.length} ${u}`)}`)}),n}getAttachmentType(t){return(0,Qt.match)(t.contentType).when(r=>r.startsWith("text/"),()=>"text").when(r=>r.startsWith("image/"),()=>"image").when(r=>r.startsWith("video/"),()=>"video").when(r=>r.startsWith("application/")&&t.name?.endsWith(".json"),()=>"json").when(r=>r.startsWith("application/")&&t.name.startsWith("trace"),()=>"trace").otherwise(()=>"unknown")}getAttachmentDetails(t){return(0,Qt.match)(t.contentType).when(r=>r.startsWith("text/"),()=>`Text ${t.contentType}:
${this.getAttachmentText(t)}`).when(r=>r.startsWith("image/"),()=>`Image (${t.contentType}): ${t.name??""} ${m(t.path??"<Buffer>")}`).when(r=>r.startsWith("video/"),()=>`Video (${t.contentType}): ${t.name??""} ${m(t.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&t.name?.endsWith(".json"),()=>`JSON file (${t.contentType}): ${t.name??""} ${m(t.path??"<Buffer>")}`).when(r=>r.startsWith("application/")&&t.name.startsWith("trace"),()=>`Trace: ${m(t.path??"<Buffer>")}`).otherwise(()=>`Attachment (${t.contentType}): ${t.name??""} ${t.path??"<Buffer>"}`)}getAttachmentText(t){if(!t.body)return;let r=t.body.toString();return r.length>300&&(r=r.slice(0,300)+"... <truncated>"),r}logAfterRunCreated(...t){this.loggerChain.then(()=>{P(...t)})}async getSummary(t,r={showLinks:!0}){let s=t.filter(v=>v.isFlaky).length,o=t.filter(v=>v.currentsState==="failed"),a=t.filter(v=>v.currentsState==="pending"),u=t.filter(v=>v.currentsState==="passed"),p=u.filter(v=>v.isFlaky),h=o.filter(v=>v.isFlaky),C=a.filter(v=>v.isFlaky),I=t.filter(v=>v.testCase.results.length===0),T=[];I.length>0&&T.push("",ot(`${nt(4)}${I.length} did not run:`),...I.map(v=>`${nt(4)}${this.getTestCaseLabel(v.testCase)}`));let K=[];this.pwConfig.maxFailures&&o.length>=this.pwConfig.maxFailures&&K.push(ot(`${nt(4)}Testing stopped early after ${this.pwConfig.maxFailures} maximum allowed failures`));let Nt=[];o.length>0&&Nt.push([`${nt(4)}${Tt(`${o.length} failed`)}`,h.length>0?`${ot(`(${h.length} flaky)`)}`:null].filter(Boolean).join(" "),...o.length>0?await this.testTree(o,Tt,{flatten:!0,showLinks:r.showLinks}):[]);let Ut=[];u.length>0&&Ut.push([p.length>0?`${nt(4)}${Bt(`${u.length} passed`)} ${ot(`(${p.length} flaky)`)}`:null].filter(Boolean).join(" "),...p.length>0?await this.testTree(p,Bt,{flatten:!0,showLinks:r.showLinks}):[]);let Lt=[];return C.length>0&&Lt.push([`${nt(4)}${kt(`${a.length} skipped`)} ${ot(`(${C.length} flaky)`)}`].join(" "),...C.length>0?await this.testTree(C,kt,{flatten:!0,showLinks:r.showLinks}):[]),[[`${nt(2)}Test results:`,[zt(t.length,`${`${t.length} overall`}`),zt(u.length,`${Bt(`${u.length} passed`)}`),zt(a.length,`${kt(`${a.length} skipped`)}`),zt(o.length,`${Tt(`${o.length} failed`)}`),zt(s,`${ot(`${s} flaky`)}`)].join(", ")].join(" "),...Nt,...Ut,...Lt,...T,...K].filter(Boolean).join(`
`)}async printSummary(t,r){this.logAfterRunCreated(await this.getSummary(r))}async testTree(t,r=G.identity,n={flatten:!1,showLinks:!0}){let s=(0,G.groupBy)(t,a=>a.projectId),o=[];return await Promise.allSettled(Object.entries(s).map(async([a,u])=>{let p=[],h=(0,G.groupBy)(u,I=>$(I.testCase,this.pwConfig)),C=!1;await Promise.allSettled(Object.entries(h).map(async([I,T])=>{if(!T.length)return;let K=await this.executionState.getDashboardUrl();if(!K)return;let Nt=await T[0].getInstanceLink(K);!C&&!n.flatten&&(p.push(r(`  [${a}]`)),C=!0);let Ut=!1;await Promise.allSettled(T.map(async Lt=>{let cn=await Lt.getTestLink(K);!Ut&&!n.flatten&&(p.push([r(`    ${I}`),Nt&&n.showLinks?`${m(Nt)}`:""].join(" ")),Ut=!0),p.push(this.testExecutionSummaryLine(Lt,cn,r,{ident:n.flatten?6:8,showProject:n.flatten,showLinks:n.showLinks}))}))})),o.push(...p)})),o}testExecutionSummaryLine(t,r,n=P,s={ident:2,showProject:!0,showLinks:!0}){let o=t.isFlaky?jt.dim(this.flakySymbol):null;return[nt(s.ident),[o,n(this.getTestCaseLabel(t.testCase,s.showProject)),...r&&s.showLinks?[m(r)]:[],m((0,Ge.default)(t.duration))].filter(a=>a!==null).join(" ")].join("")}};function nt(e=0){return" ".repeat(e)}function zt(e,t){return e>0?t:m(t)}i();i();j();R();i();var He=g(require("path"));async function qo({config:e,groupId:t,testId:r,titlePath:n}){let s=t.length>0?t:"project",o=He.default.resolve(e.dir??".nyc_output",s),a=J({target:{titlePath:n,projectId:t,testId:r},stage:"spec_reports_finding"}),u=await _e(o);if(!u)return a({event:"find",status:"failed",message:"Coverage directory not found",details:{dir:o}}),null;if(u.length===0)return a({event:"find",status:"failed",message:"No coverage files found",details:{dir:o,files:u}}),[];let p=u.filter(C=>C.startsWith(r)&&He.default.extname(C)===".json"),h=p.map(C=>He.default.join(o,C));return h.length===0?(a({event:"find",status:"failed",message:"No coverage files found. No files match the testId",details:{dir:o,testId:r,filteredFiles:p}}),[]):(a({event:"find",status:"passed",message:"Coverage files found",details:{dir:o,filteredFilePaths:h,files:h.length}}),h)}async function Ko({runId:e,groupId:t,instanceId:r,specName:n,testExecutions:s}){try{let o=w();if(!(o?.coverage?se([t],o.coverage):[]).length)return;let u=J({target:{spec:n,projectId:t},stage:"spec_reports_finding"}),p=await Promise.all(s.map(T=>qo({config:o.coverage,groupId:t,testId:T.testId,titlePath:T.titlePath}))).then(T=>T.flat().filter(K=>K));if(p.length===0){u({event:"find",status:"failed",message:"No coverage paths found for spec",details:{testExecutions:s.map(T=>T.testId),total:s.length,coveragePaths:p}});return}u({event:"find",status:"passed",message:"Coverage paths found for spec",details:{testExecutions:s.map(T=>T.testId),total:s.length,coveragePaths:p,found:p.length}});let h=J({target:{spec:n,projectId:t},stage:"spec_test_merging"}),C=await Se(p,h),I=J({target:{spec:n,projectId:t},stage:"spec_reporting"});if(!C){I({event:"report",status:"failed",message:"No coverage data found for spec",details:{coveragePaths:p,files:p.length}});return}b.createOnceForInstance({instanceId:r,groupId:t,runId:e,artifact:[{name:"coverage",body:Buffer.from(JSON.stringify(C)),contentType:"application/json",type:"coverage"}],type:"coverage"}),I({event:"report",status:"passed",message:"Coverage artifact created",details:{coveragePaths:p,files:p.length}})}catch(o){_(`Error sending coverage for spec: ${n}, groupId: ${t}`,o);return}}i();var Jo=require("lodash"),Yo=require("process");E();var ka=l.extend("testExecution"),bt=class e{constructor(t,r,n,s){this.specExecution=t;this.projectId=n;this.specName=s;this.output=new Map;this._testCase=r}get duration(){return this._testCase.results.reduce((t,r)=>t+r.duration,0)}get isFlaky(){return this._testCase.outcome()==="flaky"}get testCase(){return this._testCase}get titlePath(){return`${this.testCase.titlePath().filter(Boolean).join(" > ")}`}get currentsState(){return pt(this.testCase)}get testId(){return this.testCase.id}get getOutput(){return this.output}appendOutput(t,r){this.output.set(r??Yo.hrtime.bigint(),t)}isInterruptedWithError(){return!(!this.testCase.results.some(t=>t.status==="interrupted")||!this.testCase.results.some(t=>!!t.error))}isFinished(){let t=this.testCase.results.map(r=>r.status);return ka("isFinished?: %o",{title:this.titlePath,allStatuses:t,retries:this.testCase.retries}),!!(t.includes(this.testCase.expectedStatus)||t.length===this.testCase.retries+1)}setTestCase(t){return this._testCase=t,this}getFakeTestCase(){let t=(0,Jo.extend)(this.testCase),r=this.testCase.retries+1-t.results.length;return Array.from({length:r}).forEach(()=>{t.results.push(e.getFakeTestResult(t.results.length+1))}),t}async getInstanceLink(t){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${t}/i/${r}`:null}async getTestLink(t){let r=(await this.specExecution.instance?.creationRequest)?.instanceId;return r?`${t}/i/${r}/test/${this.testId}`:null}static getFakeTestResult(t){return{__currents_isFake:!0,status:"skipped",workerIndex:-1,parallelIndex:0,duration:0,startTime:new Date,stdout:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],stderr:["Playwright did not run this test attempt because of maximum allowed failures, or SIGINT"],attachments:[],steps:[],error:{message:"Playwright did not run this test attempt because of maximum allowed failures, or SIGINT",stack:""},errors:[],retry:t}}};var zo=l.extend("specExecution"),We=class{constructor(t,r,n,s,o){this.projectExecution=t;this.specName=r;this.projectId=n;this.tests=s;this.printer=o;this.testExecutions=new Map;this.instance=null;this.instanceFinishedTask=null}createTestExecution(t,r,n){this.testExecutions.set(t,new bt(this,r,this.projectId,this.specName))}getTestExecution(t){return this.testExecutions.get(t)}getAllTestExecutions(){return Array.from(this.testExecutions.values())}isFinished(){return this.getAllTestExecutions().every(t=>t.isFinished())}isFailed(){return this.getAllTestExecutions().map(t=>t.currentsState).some(t=>t==="failed")}hasFlakyTests(){return this.getAllTestExecutions().some(t=>t.isFlaky)}getInstanceCreation(){return Yt.get(this.projectId,this.specName)?.creationRequest}startInstanceCreation(t){return this.instance=Yt.createOnce(this.projectId,this.specName,this.tests),this.instance.startCreationOnce(t)}finish(t){this.isFinished()&&(this.instanceFinishedTask=this._startInstanceFinishedTask(t))}async _startInstanceFinishedTask(t){let r=await this.projectExecution.run;if(!r)return;zo("Starting instance finished task: %o",{ciBuildId:r.ciBuildId,projectId:this.projectId,specName:this.specName});let n=await this.getInstanceCreation();if(!n?.instanceId){d("[currents] Missing reporting instructions for spec file, skipping: [%s] \u203A %s",this.projectId,this.specName);return}if(n?.claimedCount>1){zo('[currents] Results already reported for CI build "%s" [%s] \u203A %s',r.ciBuildId,this.projectId,this.specName);return}await this.sendStdOut({instanceId:n.instanceId,groupId:this.projectId,runId:r.runId}),await Ko({runId:r.runId,groupId:this.projectId,instanceId:n.instanceId,specName:this.specName,testExecutions:this.getAllTestExecutions()})}async sendStdOut({instanceId:t,groupId:r,runId:n}){let s=this.getAllTestExecutions(),o=s.map(h=>h.getOutput),a=gt.globalOutput,u=gt.mergeOutputMaps(a,...o),p=[this.printer.getIntro(),Ct(),u.join(`
`),await this.printer.getSummary(s,{showLinks:!1}),Ct()].join(`
`);b.createOnceForInstance({instanceId:t,groupId:r,runId:n,artifact:[{name:"stdout",body:Buffer.from([p].join(`
`)),contentType:"text/plain",type:"stdout"}],type:"stdout"})}};var mm=l.extend("projectExecution"),Ve=class{constructor(t){this.projectId=t;this.specExecutions={};this.run=Promise.resolve(null)}setRun(t){return this.run=t,this}upsertSpecExecution(t,r,n,s){return this.specExecutions[t]||(this.specExecutions[t]=new We(this,t,r,n,s)),this.specExecutions[t]}getSpecExecution(t){return this.specExecutions[t]}getAllSpecExecutions(){return Object.values(this.specExecutions)}};he();var qe=class{constructor(t){this.config=t;this.projectExecutions={}}upsertProjectExecution(t){return this.projectExecutions[t]||(this.projectExecutions[t]=new Ve(t)),this.projectExecutions[t]}getProjectExecution(t){return this.projectExecutions[t]}getAllProjectExecutions(){return Object.values(this.projectExecutions)}getAllSpecExecutions(){return Object.values(this.projectExecutions).flatMap(t=>t.getAllSpecExecutions())}getAllTestExecutions(){return this.getAllSpecExecutions().flatMap(t=>t.getAllTestExecutions())}getProjectExecutionForTestCase(t){return this.getProjectExecution(tt(t))}getSpecExecution(t){return this.getProjectExecutionForTestCase(t).getSpecExecution($(t,this.config))}getTestExecution(t){return this.getSpecExecution(t).getTestExecution(M(t))}getAllPendingPromises(){return[...this.getAllSpecExecutions().map(t=>t.instanceFinishedTask).filter(z)]}getUnfinishedSpecExecutions(){return this.getAllSpecExecutions().filter(t=>!t.isFinished())}async getRun(){let t=this.getAllProjectExecutions();if(t.length)return await t[0].run}async getRunUrl(){return(await this.getRun())?.runUrl}async getRunId(){return(await this.getRun())?.runId}async getDashboardUrl(){return(await this.getRun())?.dashboardUrl}async getCiBuildId(){return(await this.getRun())?.ciBuildId}getExecutionOutcome(){let t=this.getAllSpecExecutions();return this.getAllSpecExecutions().some(n=>n.isFailed())||oe(this.config)?.failOnFlakyTests&&t.some(n=>n.hasFlakyTests())?"failed":"passed"}async getSummary(){let t=this.getAllTestExecutions(),r=await this.getDashboardUrl(),n={};if(process.env.CURRENTS_DISCOVERY_SUMMARY){let s=fe().outcome;n.discovery=s&&"result"in s?s.result:null}return{runId:await this.getRunId()??null,url:await this.getRunUrl()??null,ciBuildId:await this.getCiBuildId()??null,results:{tests:{overall:t.length,flaky:t.filter(s=>s.isFlaky).length,failed:t.filter(s=>s.currentsState==="failed").length,skipped:t.filter(s=>s.currentsState==="pending").length,passed:t.filter(s=>s.currentsState==="passed").length}},details:await Promise.all(t.map(async s=>({projectId:tt(s.testCase),url:r?await s.getTestLink(r):null,specName:s.specName,title:A(s.testCase),tags:Gt(s.testCase),status:s.currentsState,isFlaky:s.isFlaky,durationMs:s.duration,attempts:s.testCase.results.map(o=>({attemptIndex:o.retry,status:o.status,errorMessage:o.error?.message?De(o.error?.message):null}))}))),...n}}};i();le();R();i();i();var ri=require("lodash");j();E();i();var Qo=g(require("getos")),Xo=require("lodash"),H=require("os"),Zo=require("util"),ja=async()=>{if((0,H.platform)()==="linux")try{let e=await(0,Zo.promisify)(Qo.default)();return"dist"in e&&"release"in e?[e.dist,e.release].join(" - "):(0,H.release)()}catch{return(0,H.release)()}return(0,H.release)()},$a=async()=>{let e=await ja();return{osName:(0,H.platform)(),osVersion:e,osCpus:[],osMemory:{free:(0,H.freemem)(),total:(0,H.totalmem)()}}},ti=(0,Xo.memoize)($a);i();at();function ei(e){return L({method:"POST",url:"runs/v1",data:e}).then(t=>t.data).catch(t=>{if(t.response&&t.response.status===422)return null;throw t})}var Ga={tags:[]};async function ni(e){let t=w();if(!t)return null;let r=await Ue(),n=await ti(),{browser:s}=e,a={...{browserName:s.name,browserVersion:s.version},...n},u={...Ga,platform:a,commit:r,...e,projectId:t.projectId,recordKey:t.recordKey,ciBuildId:e.ci.ciBuildId.value,tags:t.tag??[],machineId:process.env.CURRENTS_MACHINE_ID??t.machineId,orchestrationId:process.env.CURRENTS_ORCHESTRATION_ID??t.orchestrationId,previousCiBuildId:process.env.CURRENTS_PREVIOUS_CI_BUILD_ID,coverage:se(wn(e.fullTestSuite),t.coverage)};u.config=vn(u.config),l("Creating run: %o",(0,ri.mapValues)(u,(p,h)=>h==="recordKey"?"******":p));try{let p=await ei(u);return l("Run created: %o",p),p}catch{return null}}i();j();E();R();he();i();var si=g(require("debug")),tn=g(require("fs")),en=g(require("tmp")),oi=require("ts-pattern");var Ke=(0,si.default)("pwc-scanner"),Wa=(e,t)=>(0,oi.match)(e).with("project",()=>t.map(r=>`--project=${r}`)).with("grep",()=>`--grep=${t}`).with("grepInvert",()=>`--grep-invert=${t}`).with("configFile",()=>`--config=${t}`).with("repeatEach",()=>`--repeat-each=${t}`).with("cliArgs",()=>null).with("cliOnlyChanged",()=>`--only-changed=${t}`).exhaustive(),ii=async(params,testFilter)=>{let{execa}=await eval('import("execa")'),tmpFile=en.default.fileSync({postfix:".json"}),scannerArgs=Object.entries(params).filter(([e,t])=>!!t).map(([e,t])=>Wa(e,t)).filter(z).map(e=>Array.isArray(e)?e:[e]).flat();Ke("scannerArgs: %O",scannerArgs);let cliParams=["test","--list",...scannerArgs,"--reporter=@currents/playwright/discovery","--shard=1/1",...params.cliArgs];Ke("running scanner: %O",cliParams);let execaResult=await execa("playwright",cliParams,{reject:!1,env:{PWTEST_WATCH:void 0,CURRENTS_DISCOVERY_PATH:tmpFile.name}}),fileContents=tn.default.readFileSync(tmpFile.name,"utf-8");if(Ke("execa result: %o",execaResult),execaResult.failed){let e=en.default.fileSync({prefix:"pwc-scanner-error",postfix:".json"});return tn.default.writeFileSync(e.name,JSON.stringify(execaResult,null,2)),console.error("Error: pwc-scanner failed. Debug: %s",e.name),{execaResult,result:null}}let result=JSON.parse(fileContents);return testFilter&&Array.isArray(result)&&(Ke("filtering tests"),result.forEach(e=>{Array.isArray(e.tests)&&(e.tests=e.tests.filter(t=>testFilter(t.testId)))})),{execaResult,result}};i();var ai=g(require("fs")),ui=e=>{try{return JSON.parse(ai.default.readFileSync(e,"utf-8"))}catch(t){console.error("Error reading test suite file",t)}};var Xt=l.extend("scanner");async function li(e){try{let t=w();if(_t("currentsConfig",t),t?.testSuiteFile)return Xt("scanner explicit test suite: %o",t.testSuiteFile),ui(t.testSuiteFile);let r=oe(e);if(_t("internalConfig",r),Xt("internal config: %o",r),!r)return null;let n;(r.lastFailedTestIdMatcher||r.testIdMatcher)&&(n=o=>{let a=!0;return r.testIdMatcher&&(a=r.testIdMatcher(o)),a&&r.lastFailedTestIdMatcher&&(a=r.lastFailedTestIdMatcher(o)),a});let s={cliArgs:r.cliArgs,project:r.cliProjectFilter,configFile:e.configFile,grep:ci(r.cliGrep),grepInvert:ci(r.cliGrepInvert),repeatEach:r.configCLIOverrides.repeatEach,cliOnlyChanged:r.cliOnlyChanged};return Xt("scanner config: %o",s),_t("scannerConfig",s),ii(s,n).then(o=>(Xt("scanner execa result: %o",o.execaResult),Xt("scanner result: %O",o.result),_t("outcome",{execaResult:o.execaResult,result:o.result}),o.result)).catch(o=>(_(o),_t("outcome",{pwcScannerError:o}),null))}catch(t){return _(t),null}}function ci(e){return e?(Array.isArray(e)?e:[e]).join(","):null}i();var pi=g(require("json-stringify-safe")),dt=require("lodash"),gi=g(require("p-debounce"));j();E();at();i();var Va={length:32,separator:"..."},rn=function(e,t={}){let{length:r,separator:n}={...Va,...t};if(!e)return;if(e.length<=r)return e.trim();let s=n.length,o=r-s,a=Math.ceil(o/2),u=Math.floor(o/2);return e.substring(0,a)+n+e.substring(e.length-u,e.length-1)};R();var vt=l.extend("trr"),nn=class e{constructor(t){this._updateRemoteTestFn=null;this.requestSequence=new sn;this.executionChain=Promise.resolve();this.updateRequestSet=new Set;this.recordId=null;this.instanceId=null;this.currentsConfig=null;this.updateCounter=0;this.attemptTriggerEvent=new Map;this.networkRequests=[];this.testCase=t.testCase,this.groupId=t.projectId,this.specName=t.specName,this.currentsConfig=w()}static{this.MAX_STEPS_PER_LEVEL=2e3}get execution(){return this.executionChain}onTestBegin(t){this.testCase=t.testCase,this.setTriggerEventForAttempt(ut(t.testCase,t.testResult??{retry:0}),"testBegin"),this.executionChain=this.executionChain.then(()=>Promise.allSettled([t.runCreation,t.instanceCreation])).then(([r,n])=>r.status==="rejected"||!r.value||n.status==="rejected"||!n.value?null:[r.value,n.value]).then(r=>{if(!r)return null;let[n,s]=r;return this.instanceId=s.instanceId,this.recordId?this.triggerUpdateRemoteTest():this.createRemoteTest(n,t.testCase,t.testResult)})}onStepBegin(t,r){this.testCase=t,this.setTriggerEventForAttempt(ut(t,r),"stepBegin"),this.triggerUpdateRemoteTest()}onStepEnd(t,r){this.testCase=t,this.setTriggerEventForAttempt(ut(t,r),"stepEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(t).join(" > "),testId:M(t),attemptId:r.retry,attachment:r.attachments,groupId:this.groupId})}onTestEnd(t,r){this.testCase=t,this.setTriggerEventForAttempt(ut(t,r),"testEnd"),this.triggerUpdateRemoteTest(),b.createOnceForAttempt({testLabel:A(t).join(" > "),testId:M(t),attemptId:r.retry,groupId:this.groupId,attachment:r.attachments})}async createRemoteTest(t,r,n){if(!this.currentsConfig?.recordKey)throw new Error("missing Currents Record Key for createRemoteTest");if(!this.currentsConfig?.projectId)throw new Error("missing Currents Project Id for createRemoteTest");if(this.instanceId)try{vt("Creating remote test record for %s",xe(r));let s=await L({method:"POST",url:"/test-record",data:{_v:0,_ct:new Date().toISOString(),_t:this.requestSequence.value,_s:pt(r),_d:this.isTestCaseFinished(),_f:this.isTestCaseFinished()&&this.isTestCaseFlaky(),runId:t.runId,instanceId:this.instanceId,testId:M(r),projectId:this.currentsConfig.projectId,groupId:this.groupId,machineId:t.machineId,spec:this.specName,expectedStatus:r.expectedStatus,annotations:this.resolveAnnotations(this.testCase),tags:Gt(r),timeout:r.timeout,location:{column:r.location.column,file:r.location.file,line:r.location.line},title:A(r),retries:r.retries,attempts:this.getAttemptListPayload(r)},currentsOptions:{enableCompression:!0}});this.recordId=s.data.recordId,vt("Remote test record created for %s, recordId: %s",A(r),this.recordId),b.setRecordId(M(r),this.recordId,this.instanceId,t.runId,t.machineId)}catch(s){d(`Cannot create remote test: %s > %s
%s`,this.specName,this.testCase.title,s.message);return}}triggerUpdateRemoteTest(){this.updateCounter++;let t=this.updateCounter;this.executionChain=this.executionChain.then(()=>{if(t!==this.updateCounter){vt("Skipping updateRemoteTest: %o",{updateCounter:t,current:this.updateCounter,recordId:this.recordId});return}return this.getUpdateRemoteTestFn()()}).catch(r=>{vt("Error while updating remote test: %o",{test:A(this.testCase),error:r.message,record:this.recordId})})}getUpdateRemoteTestFn(){return this._updateRemoteTestFn?this._updateRemoteTestFn:(this._updateRemoteTestFn=(0,gi.default)(this._updateRemoteTest.bind(this),this.getDebounceTime()),this._updateRemoteTestFn)}getDebounceTime(){return W()?1e3:3e3}async _updateRemoteTest(){if(!this.recordId)throw new Error("missing recordId for updateRemoteTest");if(!this.currentsConfig?.recordKey)throw new Error("missing recordKey for updateRemoteTest");if(!this.testCase)throw new Error("missing testCase for updateRemoteTest");let t={_v:0,_e:this.getLastAttemptTriggerEventCode(),_d:this.isTestCaseFinished(),_f:this.isTestCaseFlaky()&&this.isTestCaseFinished(),_s:pt(this.testCase),attempts:this.getAttemptListPayload(this.testCase),annotations:this.resolveAnnotations(this.testCase),tags:Gt(this.testCase)},r=this.getPayloadHash(t);if(this.updateRequestSet.has(r)){vt("Similar update request was already sent, skipping %s",this.recordId);return}this.updateRequestSet.add(r);try{return L({method:"PUT",url:`/test-record/${this.recordId}`,data:{_t:this.requestSequence.value,...t},currentsOptions:{enableCompression:!0}})}catch(n){vt("Error while updating remote test: %o",{test:A(this.testCase),error:n.message,record:this.recordId}),d(`Error while reporting remote test: %s
%s`,A(this.testCase),n.message)}}getPayloadHash(t){return ct(Buffer.from((0,pi.default)(t)))}getTestCaseAnnotations(t){return t.annotations?.map(r=>({type:r.type,description:r.description,source:"test"}))}getAttemptAnnotations(t){return t.annotations?.map(r=>({type:r.type,description:r.description,source:`attempt-${t.retry+1}`}))}resolveAnnotations(t){let r=this.getTestCaseAnnotations(t)??[],n=t.results.flatMap(s=>this.getAttemptAnnotations(s)).filter(z).filter(s=>!r.find(o=>o.type===s.type&&o.description===s.description));return(0,dt.uniqBy)([...r,...n].filter(s=>z(s.type)),s=>`${s.type}-${s.description}-${s.source}`)}getAttemptListPayload(t){return t.results.map(r=>({_s:Qr(r.status),_e:this.getTriggerEventCode(this.getAttemptLastTriggerEvent(ut(t,r))),attempt:r.retry,steps:this.getSteps(r.steps),workerIndex:r.workerIndex??-1,parallelIndex:r.parallelIndex??-1,startTime:r.startTime.toISOString(),duration:r.duration,status:r.status,stdout:this.getStdio(r.stdout),stderr:this.getStdio(r.stderr),errors:r.errors.map(n=>this.getError(n)),error:r.error?this.getError(r.error):void 0}))}isTestCaseFinished(){let t=this.testCase.results.map(r=>r.status);return(0,dt.last)(t)==="interrupted"||t.includes(this.testCase.expectedStatus)?!0:this.testCase.results.length===this.testCase.retries+1&&this.isLastAttemptFinished()}isLastAttemptFinished(){return this.getLastAttemptTriggerEvent()==="testEnd"}getLastAttemptTriggerEvent(){let t=(0,dt.last)(this.testCase.results);return t?this.getAttemptLastTriggerEvent(ut(this.testCase,t)):"testBegin"}getAttemptLastTriggerEvent(t){return this.attemptTriggerEvent.get(t)??"testBegin"}getLastAttemptTriggerEventCode(){return this.getTriggerEventCode(this.getLastAttemptTriggerEvent())}getStdio(t){return t.map(r=>typeof r=="string"?r:r.toString())}getTriggerEventCode(t){switch(t){case"testBegin":return 0;case"stepBegin":return 1;case"stepEnd":return 2;case"testEnd":return 3}}getSteps(t){let r=Object.values((0,dt.groupBy)(t,s=>s.category==="hook"?s.title:"default")),n=s=>{let o=[],a=[...s];if(a.splice(0,e.MAX_STEPS_PER_LEVEL).forEach(u=>{o.push({title:u.title,category:u.category,duration:u.duration,steps:n(u.steps),startTime:u.startTime.toISOString(),error:u.error?this.getError(u.error):void 0,location:u.location?this.getLocation(u.location):void 0})}),a.length>0){let u=a.find(p=>p.error);o.push({title:`... ${a.length} more steps`,category:a[0].category,duration:a.reduce((p,h)=>p+(h.duration||0),0),steps:[],startTime:a[0].startTime.toISOString(),error:u?.error?this.getError(u.error):void 0,location:u?.location?this.getLocation(u.location):void 0})}return o};return r.flatMap(n)}getError(t){let n=`
...truncated to fit the 2048-character limit
`;return{message:rn(t.message,{length:2048,separator:n}),stack:rn(t.stack,{length:2048,separator:n}),value:t.value,snippet:t.snippet,location:t.location?this.getLocation(t.location):void 0}}getLocation(t){return{column:t.column,file:t.file,line:t.line}}setTriggerEventForAttempt(t,r){this.attemptTriggerEvent.set(t,r)}isTestCaseFlaky(){return this.testCase.outcome()==="flaky"}},mt=class e{constructor(){this.container=new Map}static getId(t){return M(t)}create(t,r){let n=e.getId(t);return this.container.has(n)?this.get(n):(this.container.set(n,new nn({...r,testCase:t})),this.get(n))}get(t){let r=this.container.get(t);if(!r)throw new Error(`TestResultReporter for ${t} not found`);return r}getAllExecutions(){return Array.from(this.container.values()).map(t=>t.execution)}},sn=class{constructor(){this.counter=0}get value(){return this.counter++}};var B=l.extend("actor"),Je=class{constructor(t,r){this.testResultsContainer=new mt;this.suite=t,this.config=r,this.executionState=new qe(r);let n=w(),s=Xs(n?.ciBuildId);this.printer=new gt(r,t,this.executionState,n,s.ciBuildId),!W()&&P(this.printer.getIntro()),t.suites.forEach(o=>{let a=et(o.project());B("Creating project execution state for project: %s",a);let u=o.allTests(),p=u.map(I=>({specName:$(I,r),testCase:I})),h=(0,k.groupBy)(p,"specName"),C=this.executionState.upsertProjectExecution(a).setRun(this.createRun({projectId:a,project:o.project(),createRunParams:{ci:s,browser:{name:a,version:""},tests:u.map(I=>({testId:M(I),spec:$(I,r),title:A(I)})),group:a,config:{pw:this.config,currents:{autoCancelAfterFailures:n?.cancelAfterFailures,removeTitleTags:!!n?.removeTitleTags,disableTitleTags:!!n?.disableTitleTags}}}}));u.forEach(I=>{C.upsertSpecExecution($(I,r),tt(I),h[$(I,r)].map(T=>T.testCase),this.printer).createTestExecution(M(I),I,this.printer)})}),this.printer.chainRunCreation()}async createRun(t){let r=await li(this.config);return ni({...t.createRunParams,fullTestSuite:r,projectTags:t.project?.metadata?.pwc?.tags??[]}).then(n=>n?(n?.cancellation&&(pe(n.cancellation),ge()),n):(d("Could not start recording for project: %s",t.projectId),null))}onTestBegin(t){B("Test begin: %s",A(t));let r=(0,k.last)(t.results)??null,n=tt(t),s=$(t,this.config),o=this.startCreatingInstance(t);this.testResultsContainer.create(t,{specName:s,projectId:n}).onTestBegin({testCase:t,testResult:r,runCreation:this.executionState.getProjectExecution(n).run,instanceCreation:o}),this.printer.onTestBegin(t)}onTestEnd(t,r){B("Test end: %s, %o",A(t),{attempt:r.retry,status:r.status,duration:r.duration}),this.processPostTestActions(t,r),this.testResultsContainer.get(mt.getId(t)).onTestEnd(t,r);let n=this.executionState.getTestExecution(t)?.setTestCase(t);this.printer.onTestEnd(t,r).then(()=>{n?.specExecution.finish(this.config)})}onStepBegin(t,r){this.testResultsContainer.get(mt.getId(t)).onStepBegin(t,r)}onStepEnd(t,r){this.testResultsContainer.get(mt.getId(t)).onStepEnd(t,r)}async onEnd(t){B("All tests have finished, %o",t),await this.printer.onEnd(t)}async startCreatingInstance(t){let r=this.executionState.getSpecExecution(t),n=(0,k.first)((0,k.orderBy)(t.results,"startTime","asc"));return r.startInstanceCreation({run:this.executionState.getProjectExecution(r.projectId).run,startTime:n?.startTime??new Date,worker:Ms(t)})}async awaitAllResults(){B("Awaiting for completion of reporting tasks...");let t=[...this.testResultsContainer.getAllExecutions(),...this.executionState.getAllPendingPromises()];await Promise.allSettled(t)}async awaitAllUploads(){B("Awaiting for completion of all uploads..."),await Promise.allSettled(b.getAllUploads())}processSkipActions(t,r,n){if(n.status==="skipped")return;let s=t.filter(o=>o.rule.type===q.SKIP);s.length<1||(B("Late Skip Processing: %s, %o",A(r),{originalStatus:n.status,actions:s}),r.annotations.push({type:Y.ACTION_SKIP_POST,description:JSON.stringify(s[0])}),n.status="skipped")}processQuarantineActions(t,r,n){if(n.status==="skipped"||r.expectedStatus===n.status)return;let s=t.filter(a=>a.rule.type===q.QUARANTINE);if(s.length<1)return;B("Late Quarantine Processing: %s, %o",A(r),{originalStatus:n.status,actions:s});let o=s[0];o.testInfo.status=n.status,r.annotations.push({type:Y.ACTION_QUARANTINE_POST,description:JSON.stringify(o)}),n.status="skipped"}processPostTestActions(t,r){try{let o=(0,k.uniqWith)(r.attachments.filter(a=>a.name.includes(Wt.prefix)).flatMap(a=>{try{let u=a.body&&JSON.parse(a.body.toString());if(Array.isArray(u))return u}catch(u){B("Failed to parse actions attachment: %O",u)}return[]}),(a,u)=>a._id?a._id===u._id:(0,k.isEqual)(a,u));xt.applyReporter(this.config,t,o)}catch(o){B("Failed to apply reporter actions",o)}let s=(r.annotations||t.annotations).filter(o=>o.type===Y.ACTION_MATCH&&!!o.description).reduce((o,a)=>{try{o.push(JSON.parse(a.description))}catch(u){B("Failed to parse marker description: %O",u)}return o},[]);s.length<1||(this.processSkipActions(s,t,r),this.processQuarantineActions(s,t,r))}reportUnfinishedSpecExecutions(){this.executionState.getUnfinishedSpecExecutions().forEach(t=>{B("Spec execution with no results: %s",t.specName);let r=t.getAllTestExecutions().filter(s=>!s.isFinished()).map(s=>s.getFakeTestCase());if(!r.length)return;B("Non-finished tests: %o",r.map(s=>s.titlePath()));let n=`Playwright did not finish running ${(0,on.default)("test",r.length,!0)}, reporting missing attempts as ${jt("skipped")}:
`;r.forEach(s=>{let o=s.results.filter(a=>a.__currents_isFake).length;n+=m(`- ${xe(s)} (${o} ${(0,on.default)("attempt",o)})
`),this.onTestBegin(s),this.onTestEnd(s,(0,k.last)(s.results)??bt.getFakeTestResult(0))}),Et(n)})}};i();E();i();var di=g(require("ws"));E();var Ye=l.extend("ws"),Ot=null;async function an(e){await qa(),await new Promise((t,r)=>{if(!Ot){r(new Error("WebSocket is not initialized"));return}Ye("sending message to ws: %o, %o",Ot.url,e),Ot.send(JSON.stringify(e),n=>{n?r(n):t()})})}async function qa(){if(Ot){Ye("ws already initialized");return}let e=parseInt(process.env.CURRENTS_PWCP_WSS_PORT);Ye("setting port to %s",e),await new Promise(t=>{Ot=new di.default(`ws://localhost:${e}`),Ot.on("open",()=>{Ye("ws opened"),t(null)})})}var Ka=l.extend("or8n-ws");async function mi(e){let t=!!process.env.CURRENTS_OR8N_SEND_RESULTS_TO_WSS;if(!t){Ka("Skipping sending JSON summary to WSS: %o",{shouldSendToWSS:t});return}await an({type:"execution:summary",payload:await e.executionState.getSummary()})}async function fi(){await an({type:"orchestration:task-finished",payload:{}})}var un=l.extend("reporter"),hi=l.extend("step"),Zt=class{constructor(t){this.errors=[];this._testActor=null;this.startTime=new Date;this.fullConfig=null;this.remoteDebug=Te.factory("core"),this.configLoader=new Pt(t,this.onC12ConfigLoaded).start();try{this.startTime=new Date}catch(r){(0,ze.match)(r).with(ze.P.instanceOf(ft),()=>{process.exit(1)}).otherwise(n=>{throw _("Unexpected error",n),new Error("Unexpected error")})}}printsToStdio(){return!0}onStdOut(t,r,n){this.testActor.printer.onStdOut(t,r,n)}onStdErr(t,r,n){this.testActor.printer.onStdErr(t,r,n)}onBegin(t,r){this.configLoader.waitSync(),this.fullConfig=t,un("Beginning tests execution: %o",r.allTests().map(n=>n.titlePath())),W()||Pn(t),ps(t.version),jn(),this._testActor=new Je(r,t)}onError(t){_(`Global error reported by test runner:
%s`,Jr(this.fullConfig,t,!0).message),this.errors.push(t)}onStepBegin(t,r,n){hi("> %s %s",n.category,n.title),this.testActor.onStepBegin(t,r)}onStepEnd(t,r,n){hi("< %s %s",n.category,n.title),this.testActor.onStepEnd(t,r)}onTestBegin(t){this.testActor.onTestBegin(t)}onTestEnd(t,r){this.testActor.onTestEnd(t,r)}async onEnd(t){try{await this.testActor.onEnd(t),this.testActor.reportUnfinishedSpecExecutions(),await this.testActor.printer.farewell(this.startTime,b.getAllUploads().length),await this.testActor.awaitAllResults(),W()&&(await mi({executionState:this.testActor.executionState}),this.isOr8nEventMode()?(un("Orchestrated run with event mode enabled: sending execution state and marking task as finished before uploads complete."),await fi()):un("Orchestrated run in loop mode detected. Sending execution state after execution completes.")),m("  Finalizing uploading artifacts to Currents..."),await this.testActor.awaitAllUploads();let r=await this.testActor.executionState.getRunUrl();if(r&&process.env.CURRENTS_RUN_URL_FILE&&(console.log("Writing run url to file",process.env.CURRENTS_RUN_URL_FILE),Ei.default.writeFileSync(process.env.CURRENTS_RUN_URL_FILE,r)),!this.testActor.executionState.getAllSpecExecutions().length)return It(),d("No tests detected, stopping execution"),It(),t;this.errors.length>0&&(Et(`Execution errors:
`),this.errors.forEach(o=>console.error(o.message))),Ft.length>0&&(gn(`Execution errors:
`),Ft.forEach(o=>P(o))),st.length&&(Et(`Execution warnings:
`),st.forEach(o=>P(o))),b.uploadWarnings.size>0&&(Et(`Upload warnings:
`),b.uploadWarnings.forEach(o=>P(o)));let s=await this.testActor.executionState.getRunId();if(process.env._CURRENTS_E2E_TESTS&&await new Promise(o=>setTimeout(o,1e3)),!W()){let o=w()?.outputFile;o&&await Ho({outputFile:o,summary:await this.testActor.executionState.getSummary()}),It(),P("\u{1F3C1} Done!")}return await this.remoteDebug.finalize({runId:s}),{status:this.testActor.executionState.getExecutionOutcome()}}catch(r){return console.error(r),{status:"failed"}}finally{$n()}}onC12ConfigLoaded(t){Object.keys(t.config).length>0&&m("Using config file: %s",t.configFile)}get testActor(){if(!this._testActor)throw new Error("@currents/playwright panic: Test actor not initialized");return this._testActor}isOr8nEventMode(){return process.env.CURRENTS_OR8N_EVENT_MODE==="true"}};var Ja=e=>["@currents/playwright",e],Ya={baseFixtures:Po,coverageFixtures:bo,actionFixtures:wo},za={includeCurrentsWrappers:vo},Qa=Zt;0&&(module.exports={configHelpers,currentsReporter,fixtures});
/*! For license information please see index.js.LEGAL.txt */
//# sourceMappingURL=index.js.map